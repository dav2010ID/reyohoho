import{_ as le,l as p,U as r,x as re,v as ne,A as ie,o as ue,c as m,d as u,F as j,r as ce,t as k,g as E,D as w,n as V,m as q,E as de,e as J,S as ve,aS as pe,P as B,J as F,k as fe,aT as ye,ai as he,M as ge,b as h,h as we,R as be,ak as Ae}from"./index-BUGt0pAR.js";import{M as me}from"./MovieList-EG8QIlYQ.js";import{N as _e}from"./ToastMessage-DMmbMYqp.js";import{B as ke}from"./BaseModal-j6_yVKz9.js";import"./SpinnerLoading-BkEOPueM.js";import"./icon-imdb-logo-5qtstUwS.js";import"./htmlSanitizer-Cf6jTOTR.js";const Ee={class:"wrapper"},Le={class:"user-lists-page",tabindex:"0"},Se={class:"controls"},Ne={class:"filter-card type-card"},Te={class:"button-group type-buttons"},Ce=["disabled","onClick"],De={key:0,class:"counter"},Re=["disabled"],Ie=["disabled"],Oe=["disabled"],xe={class:"material-icons"},Me=["disabled"],He={key:0,class:"empty-state"},$e={__name:"UserLists",setup(Be){const d=p([]),n=p(!0),c=p(r.FAVORITE),b=p(""),L=p(null),f=re(),S=ve(),N=ge(),g=p(S.params.user_id),R=p(!1),M=p({}),T=ne(),U=p(null),I=p(!1),y=p(null),_=[r.FAVORITE,r.LATER,r.WATCHING,r.COMPLETED,r.ABANDONED,r.RATED,r.HISTORY],C=fe(()=>{var t;return!g.value||String(g.value)===String((t=f.user)==null?void 0:t.id)}),O=t=>{const e=Number(t);return Number.isInteger(e)&&e>0?e:null},x=t=>Array.isArray(t)?t.map(e=>{var s,o;const a=O(e==null?void 0:e.kp_id);return a?{kp_id:a,title:typeof(e==null?void 0:e.title)=="string"?e.title:"",year:(s=e==null?void 0:e.year)!=null?s:"",type:(o=e==null?void 0:e.type)!=null?o:"",poster:typeof(e==null?void 0:e.poster)=="string"?e.poster:"",addedAt:typeof(e==null?void 0:e.addedAt)=="string"&&!Number.isNaN(Date.parse(e.addedAt))?e.addedAt:new Date().toISOString()}:null}).filter(Boolean):[],P=(t,e)=>{const a=new Map,s=o=>{const l=a.get(o.kp_id);if(!l){a.set(o.kp_id,o);return}const i=Date.parse(l.addedAt||0);Date.parse(o.addedAt||0)>i&&a.set(o.kp_id,o)};return x(t).forEach(s),x(e).forEach(s),Array.from(a.values()).sort((o,l)=>Date.parse(l.addedAt)-Date.parse(o.addedAt))},z=async()=>{if(!f.token)throw new Error("Необходимо авторизоваться");const t={};return(await Promise.allSettled(_.map(async a=>{const s=await B(a),o=Array.isArray(s)?[...new Set(s.map(l=>O(l==null?void 0:l.kp_id)).filter(Boolean))]:[];return{type:a,ids:o}}))).forEach((a,s)=>{const o=_[s];t[o]=a.status==="fulfilled"?a.value.ids:[]}),{format:"reyohoho-user-data",version:1,exportedAt:new Date().toISOString(),data:{serverLists:t,localHistory:x(T.history)}}},G=t=>{const e=new window.Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=window.URL.createObjectURL(e),s=document.createElement("a"),o=new Date().toISOString().slice(0,10);s.href=a,s.download="reyohoho-export-".concat(o,".json"),document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(a)},W=async()=>{if(C.value)try{n.value=!0;const t=await z();G(t),y.value.showNotification("Экспорт сохранен")}catch(t){y.value.showNotification((t==null?void 0:t.message)||"Ошибка при экспорте")}finally{n.value=!1}},Y=()=>{var t;C.value&&((t=U.value)==null||t.click())},K=t=>{var l,i;const e=t&&typeof t=="object"?t:{},a=((l=e==null?void 0:e.data)==null?void 0:l.serverLists)||(e==null?void 0:e.serverLists)||(e==null?void 0:e.lists)||{},s=((i=e==null?void 0:e.data)==null?void 0:i.localHistory)||(e==null?void 0:e.localHistory)||(e==null?void 0:e.history)||[],o={};return _.forEach(v=>{const A=Array.isArray(a[v])?[...new Set(a[v].map(O).filter(Boolean))]:[];o[v]=A}),{lists:o,localHistory:x(s)}},Q=async t=>{if(!f.token)throw new Error("Необходимо авторизоваться для импорта списков");let e=0,a=0;const s={};for(const o of _)try{const l=await B(o);s[o]=new Set((Array.isArray(l)?l:[]).map(i=>O(i==null?void 0:i.kp_id)).filter(Boolean))}catch(l){s[o]=new Set}for(const o of _){const l=t[o]||[];for(const i of l)if(!s[o].has(i))try{await he(i,o),s[o].add(i),e+=1}catch(v){a+=1}}return{addedCount:e,failedCount:a}},X=async t=>{const[e]=t.target.files||[];if(t.target.value="",!(!e||!C.value))try{I.value=!0,n.value=!0;const a=await e.text(),s=JSON.parse(a),o=K(s),l=_.some(A=>(o.lists[A]||[]).length>0),i=o.localHistory.length>0;if(!l&&!i){y.value.showNotification("Файл импорта пустой или невалидный");return}const v=[];if(l){const{addedCount:A,failedCount:D}=await Q(o.lists);v.push("списки: +".concat(A)),D>0&&v.push("ошибок: ".concat(D))}if(i){const A=T.history.length,D=P(T.history,o.localHistory);T.setHistory(D);const oe=Math.max(0,D.length-A);v.push("история: +".concat(oe))}await $(),y.value.showNotification(v.length?"Импорт завершен (".concat(v.join(", "),")"):"Импорт завершен")}catch(a){y.value.showNotification("Ошибка импорта: проверьте формат JSON")}finally{I.value=!1,n.value=!1}},Z=async()=>{var t;try{const e=window.location.origin+window.location.pathname.split("/lists")[0]+"/lists",a=g.value||((t=f.user)==null?void 0:t.id),s=S.query.type||c.value,o=a?"".concat(e,"/").concat(a,"?type=").concat(s):"".concat(e,"?type=").concat(s);await navigator.clipboard.writeText(o),y.value.showNotification("Скопировано")}catch(e){console.error("Ошибка копирования:",e)}},ee=[{label:"Избранное",value:r.FAVORITE},{label:"Смотрю",value:r.WATCHING},{label:"Позже",value:r.LATER},{label:"Просмотрено",value:r.COMPLETED},{label:"Брошено",value:r.ABANDONED},{label:"Оценено",value:r.RATED}],H=async()=>{var t;try{const e=g.value||((t=f.user)==null?void 0:t.id);e&&(M.value=await ye(e))}catch(e){console.error("Error fetching counters:",e)}},$=async()=>{n.value=!0,b.value="",L.value=null;try{g.value?d.value=await pe(c.value,g.value):d.value=await B(c.value),await H()}catch(t){const{message:e,code:a}=F(t);b.value=e,L.value=a,d.value=[]}finally{n.value=!1}},te=t=>{c.value=t,N.push({query:{...S.query,type:t}})},se=async()=>{if(n.value=!0,f.token)try{await be(c.value),d.value=[],y.value.showNotification("Список очищен"),await H()}catch(t){const{message:e,code:a}=F(t);b.value=e,L.value=a,console.error("Ошибка при очистке списка:",t),a===401&&(f.logout(),await N.push("/login"),N.go(0))}n.value=!1,R.value=!1},ae=async t=>{if(f.token)try{await Ae(t,c.value),d.value=d.value.filter(e=>e.kp_id!==t),y.value.showNotification("Фильм удален из списка"),await H()}catch(e){const{message:a,code:s}=F(e);b.value=a,L.value=s,console.error("Ошибка при удалении фильма:",e),s===401&&(f.logout(),await N.push("/login"),N.go(0))}};return ie(()=>S.query.type,t=>{t&&Object.values(r).includes(t)&&(c.value=t,$())}),ue(()=>{const t=S.query.type;t&&Object.values(r).includes(t)&&(c.value=t),$()}),(t,e)=>{var a;return h(),m(j,null,[u("div",Ee,[u("div",Le,[u("div",Se,[u("div",Ne,[u("div",Te,[e[6]||(e[6]=u("i",{class:"material-icons card-icon"},"movie",-1)),(h(),m(j,null,ce(ee,(s,o)=>u("button",{key:o,class:V(["filter-btn type-btn",{active:c.value===s.value,disabled:n.value}]),disabled:n.value,onClick:l=>te(s.value)},[we(k(s.label)+" ",1),M.value[s.value]?(h(),m("span",De,k(M.value[s.value]),1)):E("",!0)],10,Ce)),64)),u("button",{class:"share-btn",disabled:n.value,title:"Поделиться списком",onClick:e[0]||(e[0]=s=>Z())},[...e[3]||(e[3]=[u("span",{class:"material-icons"},k("share"),-1)])],8,Re),C.value?(h(),m("button",{key:0,class:"share-btn",disabled:n.value,title:"Экспортировать",onClick:W},[...e[4]||(e[4]=[u("span",{class:"material-icons"},k("download"),-1)])],8,Ie)):E("",!0),C.value?(h(),m("button",{key:1,class:"share-btn",disabled:n.value||I.value,title:"Импортировать",onClick:Y},[u("span",xe,k(I.value?"hourglass_top":"upload"),1)],8,Oe)):E("",!0),!g.value||String(g.value)===String((a=w(f).user)==null?void 0:a.id)?(h(),m("button",{key:2,class:V(["clear-btn",{disabled:!d.value.length||c.value===w(r).RATED||n.value}]),disabled:!d.value.length||c.value===w(r).RATED||n.value,title:"Очистить список",onClick:e[1]||(e[1]=s=>d.value.length&&c.value!==w(r).RATED&&(R.value=!0))},[...e[5]||(e[5]=[u("span",{class:"material-icons"},k("delete_sweep"),-1)])],10,Me)):E("",!0)])])]),u("input",{ref_key:"importFileInput",ref:U,type:"file",accept:"application/json,.json",class:"hidden-file-input",onChange:X},null,544),d.value.length===0&&!n.value?(h(),m("div",He,[...e[7]||(e[7]=[u("span",{class:"material-icons"},"movie",-1),u("p",null,"Нет фильмов для отображения",-1)])])):b.value?E("",!0):(h(),q(w(me),{key:1,"movies-list":d.value,"is-history":!1,"is-mobile":w(T).isMobile,"is-user-list":!0,"show-delete":c.value!==w(r).RATED,"show-star":c.value===w(r).RATED,loading:n.value,onItemDeleted:ae},null,8,["movies-list","is-mobile","show-delete","show-star","loading"])),b.value?(h(),q(de,{key:2,message:b.value,code:L.value},null,8,["message","code"])):E("",!0)])]),J(_e,{ref_key:"notificationRef",ref:y},null,512),J(ke,{"is-open":R.value,message:"Вы уверены, что хотите очистить список?",onConfirm:se,onClose:e[2]||(e[2]=s=>R.value=!1)},null,8,["is-open"])],64)}}},ze=le($e,[["__scopeId","data-v-d02eedc6"]]);export{ze as default};
