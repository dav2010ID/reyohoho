import{_ as qt,b as x,c as I,d as n,h as Ye,t as S,F as He,r as nt,n as q,g as oe,s as pt,l as f,k as ae,v as co,x as Qo,S as en,M as uo,A as et,o as vo,X as tn,m as Lt,E as on,f as so,u as ee,Y as te,D as he,U as X,e as Dt,aB as nn,aC as sn,J as io,$ as _t,aD as lo,aE as ln,ak as an,ai as rn,am as ao,au as tt,ad as cn,aF as un,aG as ro}from"./index-Ct7oQXl6.js";import{S as dn}from"./SpinnerLoading-Cxzs-4o4.js";import{N as po}from"./ToastMessage-hkAfnwBE.js";import{u as vn,S as pn}from"./player-Dc1vkSDw.js";import{_ as mn}from"./icon-imdb-logo-5qtstUwS.js";const Us="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVR4nO2ZQUoDMRSGR7eewHoFsVS0HkUUXNXqASqK2EURBPFIVRe6c+UN1CvUXWvbT4KvMAwzNnnJdCrmg1BKad7/v7y0b5IkiUQiCwGoAx3gQjEugZ0qxTeAIX6MKjMBnBOGS62AVWAPOHVYdlMu9YArYOhphLeBT+ALmOKGEd2QubaAK+B2zngFxt4GgDXgGZjgR8ch5oEkCi8DkvlnRcYLV0Apfqw10M7JvPkV6AN3FmVwK+WyZRnvMEe8ef/ibECyb2o+zRuwnpQAxeLNivQ0BvYyE46qEJ/8fK4ycJKp/X4V4n0MdDNfukkqEO9jwP1LDgD7BeKPgmgp04CL+KUz4Cp+qQxoxC+NAdsNm4c0hWkukkUa8BGfegiadbFDq3/2UAZ8xc+QVvzMtqcKYkBaZ5/MN5xEl2DgLGDZ1KswsC09FPJqXTZoNm5oA6kyMGI2FxqfkluJ0uMTDfhBXAHiHvCCWEL8/RLqlv1MPCf+TSZ+13WC7KnEfWlqcwAeU7GNjnbiQsG5UC1ZAEAt1UMhOpquk6zknMy9l20C2AA+MnEHRo9msuOCs9EH4Fp5TVQ0rqVs0plH4re02Qh1Oq1lCjypsp+5H3gKcD/gykTirqnFZ/ZDy+OGxpapzD+QePrM/2KkKfcGPcv7AdvRkz23G1x4JPIP+AY3r/ywUk/2JAAAAABJRU5ErkJggg==",Ks="/reyohoho/assets/icon-shikimori-DGvXK9Jc.svg",ot=H=>{const l=document.createElement("div");l.style.position="fixed",l.style.top="0",l.style.left="0",l.style.width="100%",l.style.height="100%",l.style.backgroundColor="rgba(0, 0, 0, 0.8)",l.style.color="white",l.style.display="flex",l.style.justifyContent="center",l.style.alignItems="center",l.style.fontSize="2rem",l.style.zIndex="99000",l.textContent=H,document.body.appendChild(l),setTimeout(()=>{document.body.removeChild(l)},2e3)},fn={key:0},gn={key:1},yn={class:"players-list"},hn=["onClick"],bn={key:0,class:"warning-icon material-icons",title:"Внимание!"},wn=["onClick"],kn={key:0,class:"warning-icon material-icons",title:"Внимание!"},xn=["onClick"],Sn={key:0,class:"warning-icon material-icons",title:"Внимание!"},Cn={__name:"PlayerModal",props:{players:{type:Array,required:!0},selectedPlayer:{type:Object,default:null}},emits:["close","select"],setup(H,{emit:l}){const p=H,r=l,h=f(null),C=ae(()=>{const g=[],B=new Set;for(const v of p.players)D(v)?B.has("veoveo")||(g.push({type:"group",name:"veoveo",displayName:"VeoVeo"}),B.add("veoveo")):$(v)?B.has("kodik")||(g.push({type:"group",name:"kodik",displayName:"Kodik"}),B.add("kodik")):g.push({type:"player",data:v});return g}),D=g=>g.name.toUpperCase().includes("VEOVEO"),$=g=>g.name.toUpperCase().includes("KODIK"),c=g=>String(g||"").replace(/VEOVEO>/,"").replace(/KODIK>/,"").replace(/KINOBOX>/,"").trim(),U=g=>{const B=String((g==null?void 0:g.provider)||"").trim();if(B)return c(B);const v=String((g==null?void 0:g.name)||(g==null?void 0:g.key)||"");if(!v.includes(">"))return"";const O=v.split(">").map(Be=>Be.trim()).filter(Boolean);if(!O.length)return"";const z=O[0].toUpperCase();return(z==="KINOBOX"||z==="KINOBD"||z==="RHSERV")&&O[1]?c(O[1]):c(O[0])},J=g=>{const B=c(g==null?void 0:g.translate),v=U(g);return v?!B||B.toLowerCase()===v.toLowerCase()?v:"".concat(v," / ").concat(B):B},M=g=>{r("select",g),r("close")},ie=g=>p.selectedPlayer&&p.selectedPlayer.key===g.key,K=g=>p.selectedPlayer?g==="veoveo"&&D(p.selectedPlayer)||g==="kodik"&&$(p.selectedPlayer):!1,F=g=>{h.value=g},k=()=>{h.value=null},Ce=g=>{let B=p.players.filter(v=>g==="veoveo"&&D(v)||g==="kodik"&&$(v));return g==="kodik"?B.sort((v,O)=>c(v.translate).localeCompare(c(O.translate))):B},Ne=g=>Ce(g).some(B=>B.warning);return(g,B)=>(x(),I("div",{class:"modal",onClick:B[2]||(B[2]=pt(v=>g.$emit("close"),["self"]))},[n("div",{class:"modal-content",onClick:B[1]||(B[1]=pt(()=>{},["stop"]))},[n("button",{class:"close",onClick:B[0]||(B[0]=v=>g.$emit("close"))},"×"),h.value?(x(),I("h2",gn,[n("button",{class:"back-btn",onClick:k},"← Назад"),Ye(" "+S(h.value),1)])):(x(),I("h2",fn,"Выберите плеер")),n("ul",yn,[h.value?(x(!0),I(He,{key:1},nt(Ce(h.value),v=>(x(),I("li",{key:v.key},[n("button",{class:q(["player-item",{active:ie(v)}]),onClick:O=>M(v)},[Ye(S(J(v))+" ",1),v.warning?(x(),I("span",Sn,"warning")):oe("",!0)],10,xn)]))),128)):(x(!0),I(He,{key:0},nt(C.value,v=>(x(),I("li",{key:v.type==="player"?v.data.key:v.name},[v.type==="player"?(x(),I("button",{key:0,class:q(["player-item",{active:ie(v.data)}]),onClick:O=>M(v.data)},[Ye(S(J(v.data))+" ",1),v.data.warning?(x(),I("span",bn,"warning")):oe("",!0)],10,hn)):(x(),I("button",{key:1,class:q(["group-item",{active:K(v.name)}]),onClick:O=>F(v.name)},[B[3]||(B[3]=n("span",{class:"material-icons group-icon"},"folder",-1)),Ye(" "+S(v.displayName)+" ",1),Ne(v.name)?(x(),I("span",kn,"warning")):oe("",!0)],10,wn))]))),128))])])]))}},In=qt(Cn,[["__scopeId","data-v-606f42c4"]]);class En{constructor(){this.ws=null,this.isConnected=!1,this.isAuthenticated=!1,this.messageId=0,this.sources=new Map,this.filtersFound=new Map,this.pendingRequests=new Map,this.callbacks={onConnect:null,onDisconnect:null,onSourcesUpdated:null,onFiltersFound:null,onError:null},this.BLUR_FILTER_NAME="reyohoho"}generateMessageId(){return++this.messageId}setCallbacks(l){this.callbacks=l}async connect(l="localhost",p=4455,r=""){return new Promise((h,C)=>{const D="ws://".concat(l,":").concat(p);console.log("Connecting to OBS WebSocket at ".concat(D)),this.ws=new WebSocket(D),this.ws.onopen=async()=>{var $,c;console.log("WebSocket connection opened");try{const U=await this.authenticate(r);console.log("Authentication response:",U),U.success?(console.log("Successfully authenticated to OBS"),(c=($=this.callbacks).onConnect)==null||c.call($),this.loadSourcesAndSearchFilters(),h()):(console.error("Authentication failed"),C(new Error("Authentication failed")))}catch(U){console.error("Error during authentication:",U),C(U)}},this.ws.onmessage=$=>{this.handleMessage(JSON.parse($.data))},this.ws.onclose=()=>{var $,c;console.log("WebSocket connection closed"),(c=($=this.callbacks).onDisconnect)==null||c.call($)},this.ws.onerror=$=>{var c,U;console.error("WebSocket error:",$),(U=(c=this.callbacks).onError)==null||U.call(c,$.message||"Connection error"),C($)}})}disconnect(){if(this.ws&&(this.ws.close(),this.ws=null),this.pendingRequests){for(const[,{reject:l}]of this.pendingRequests.entries())l(new Error("Connection closed"));this.pendingRequests.clear()}this.sources.clear(),this.filtersFound.clear()}sendRequest(l,p={}){return new Promise((r,h)=>{if(!this.isConnected||!this.ws){console.warn("No connection to OBS"),h(new Error("No connection to OBS"));return}const C=this.generateMessageId().toString(),D={op:6,d:{requestType:l,requestId:C,requestData:p}};console.log("Sending OBS request: ".concat(l),p),this.pendingRequests.set(C,{resolve:r,reject:h}),this.ws.send(JSON.stringify(D)),setTimeout(()=>{this.pendingRequests&&this.pendingRequests.has(C)&&(this.pendingRequests.delete(C),h(new Error("Request ".concat(l," timed out"))))},1e4)})}handleMessage(l){switch(l.op){case 0:this.handleHello(l.d);break;case 2:this.handleIdentified();break;case 7:this.handleRequestResponse(l.d);break;case 5:this.handleEvent(l.d);break;default:console.log("Unknown OBS message: op=".concat(l.op))}}authenticate(l=""){return new Promise(p=>{this.password=l,this.authResolve=p})}async handleHello(l){console.log("Received OBS hello"),this.isConnected=!0;const p={op:1,d:{rpcVersion:1}};if(l.authentication&&this.password)try{const r=new TextEncoder,h=await crypto.subtle.digest("SHA-256",r.encode(this.password+l.authentication.salt)),C=Array.from(new Uint8Array(h)),D=btoa(String.fromCharCode(...C)),$=await crypto.subtle.digest("SHA-256",r.encode(D+l.authentication.challenge)),c=Array.from(new Uint8Array($)),U=btoa(String.fromCharCode(...c));p.d.authentication=U}catch(r){console.error("Authentication error:",r)}this.ws.send(JSON.stringify(p))}handleIdentified(){console.log("OBS authentication successful"),this.isAuthenticated=!0,this.authResolve&&(this.authResolve({success:!0}),this.authResolve=null)}handleRequestResponse(l){const{requestId:p,requestType:r,requestStatus:h,responseData:C}=l;if(console.log("Received response for ".concat(r,":"),{success:h.result,code:h.code,comment:h.comment}),!this.pendingRequests){console.warn("No pending requests map");return}const D=this.pendingRequests.get(p);if(!D){console.warn("No pending request found for ID: ".concat(p));return}this.pendingRequests.delete(p),h.result?(console.log("Request ".concat(r," successful"),C),D.resolve(C)):(console.error("Request ".concat(r," failed:"),h.comment),D.reject(new Error("".concat(r," failed: ").concat(h.comment))))}handleFilterListResponse(l){const p=l.sourceName,h=(l.filters||[]).find(C=>C.filterName.toLowerCase()===this.BLUR_FILTER_NAME.toLowerCase());h&&(this.foundFilters.set(p,{sourceName:p,filterName:h.filterName,enabled:h.filterEnabled}),console.log("Found reyohoho filter in source: ".concat(p))),this.checkSearchComplete()}checkSearchComplete(){setTimeout(()=>{var l,p;console.log("Search complete. Found ".concat(this.foundFilters.size," reyohoho filters")),(p=(l=this.callbacks).onFiltersFound)==null||p.call(l,Array.from(this.foundFilters.values()))},500)}handleEvent(l){console.log("OBS event: ".concat(l.eventType))}async testConnection(){try{console.log("Testing OBS connection...");const l=await this.sendRequest("GetVersion");return console.log("OBS connection test successful:",l),{success:!0,version:l}}catch(l){return console.error("OBS connection test failed:",l),{success:!1,error:l.message}}}async loadSourcesAndSearchFilters(){var l,p,r,h,C,D,$,c,U,J;try{console.log("Loading sources and searching for filters...");try{const F=await this.sendRequest("GetVersion");console.log("OBS version info:",F)}catch(F){console.warn("Could not get OBS version:",F)}console.log("Requesting scene list...");const M=await this.sendRequest("GetSceneList");if(console.log("Raw scenes response:",M),!M||!M.scenes){console.error("Invalid scenes response structure:",M),(p=(l=this.callbacks).onError)==null||p.call(l,"Invalid response from OBS - no scenes data");return}console.log("Found scenes:",M.scenes.length),console.log("Requesting input list...");const ie=await this.sendRequest("GetInputList");if(console.log("Raw inputs response:",ie),!ie||!ie.inputs){console.error("Invalid inputs response structure:",ie),(h=(r=this.callbacks).onError)==null||h.call(r,"Invalid response from OBS - no inputs data");return}console.log("Found inputs:",ie.inputs.length),this.sources.clear(),this.filtersFound.clear();for(const F of M.scenes)if(console.log("Checking scene: ".concat(F.sceneName," with ").concat(F.sceneItems?F.sceneItems.length:0," items")),F.sceneItems&&Array.isArray(F.sceneItems))for(const k of F.sceneItems)k.sourceName&&(this.sources.set(k.sourceName,{sceneName:F.sceneName,sourceId:k.sceneItemId,sourceName:k.sourceName}),await this.searchFiltersInSource(k.sourceName,F.sceneName));for(const F of ie.inputs)console.log("Checking input: ".concat(F.inputName)),this.sources.has(F.inputName)||this.sources.set(F.inputName,{sceneName:"Direct Input",sourceId:null,sourceName:F.inputName}),await this.searchFiltersInSource(F.inputName,"Direct Input");const K=Array.from(this.filtersFound.values());console.log("Total filters found:",K.length),K.forEach(F=>{console.log("- ".concat(F.sourceName,": ").concat(F.filterName," (").concat(F.enabled?"enabled":"disabled",")"))}),(D=(C=this.callbacks).onFiltersFound)==null||D.call(C,K),(c=($=this.callbacks).onSourcesUpdated)==null||c.call($,Array.from(this.sources.values()))}catch(M){console.error("Error loading sources:",M),console.error("Error stack:",M.stack),(J=(U=this.callbacks).onError)==null||J.call(U,"Error loading sources: ".concat(M.message))}}async searchFiltersInSource(l,p){try{console.log("Searching filters in source: ".concat(l));const r=await this.sendRequest("GetSourceFilterList",{sourceName:l});console.log("Source ".concat(l," has ").concat(r.filters.length," filters"));for(const h of r.filters){console.log("  Filter: ".concat(h.filterName," (").concat(h.filterEnabled?"enabled":"disabled",")"));const C="".concat(l,"::").concat(h.filterName);this.filtersFound.set(C,{id:C,sourceName:l,sceneName:p,filterName:h.filterName,enabled:h.filterEnabled})}}catch(r){console.warn("Could not get filters for source ".concat(l,":"),r)}}async enableBlur(l){var r,h;if(!l){console.warn("No filter selected for blur");return}const p=this.filtersFound.get(l);if(!p){console.warn("Selected filter not found:",l);return}try{await this.sendRequest("SetSourceFilterEnabled",{sourceName:p.sourceName,filterName:p.filterName,filterEnabled:!0}),p.enabled=!0,console.log("Enabled blur filter: ".concat(p.sourceName,"::").concat(p.filterName))}catch(C){(h=(r=this.callbacks).onError)==null||h.call(r,"Error enabling filter: ".concat(C.message))}}async disableBlur(l){var r,h;if(!l){console.warn("No filter selected for blur");return}const p=this.filtersFound.get(l);if(!p){console.warn("Selected filter not found:",l);return}try{await this.sendRequest("SetSourceFilterEnabled",{sourceName:p.sourceName,filterName:p.filterName,filterEnabled:!1}),p.enabled=!1,console.log("Disabled blur filter: ".concat(p.sourceName,"::").concat(p.filterName))}catch(C){(h=(r=this.callbacks).onError)==null||h.call(r,"Error disabling filter: ".concat(C.message))}}async testBlur(l,p=2e3){if(!l){console.warn("No filter selected for test");return}await this.enableBlur(l),setTimeout(()=>{this.disableBlur(l)},p)}getFilterById(l){return this.filtersFound.get(l)}getAllFilters(){return Array.from(this.filtersFound.values())}}const Tn={class:"players-list"},$n={class:"source-modal"},An={key:0,class:"source-loading"},Mn={key:1,class:"source-error"},Bn={key:2,class:"source-empty"},Fn={key:3,class:"source-candidate-list"},Pn=["onClick"],Nn={class:"source-title"},On={class:"source-meta"},Rn=["src"],Ln={key:2,class:"controls"},_n={class:"main-controls"},Dn={class:"material-icons"},qn={class:"list-button-item"},Hn={class:"material-icons"},Vn={class:"list-button-item"},Wn={class:"material-icons"},zn={class:"list-button-item"},Un={class:"list-button-item"},Kn={class:"material-icons"},Gn={class:"list-button-item"},Yn={class:"material-icons"},jn={class:"tooltip-container","data-tooltip-container":"dimming"},Xn={class:"material-icons"},Jn={class:"tooltip-container","data-tooltip-container":"blur"},Zn={class:"tooltip-container","data-tooltip-container":"compressor"},Qn={class:"tooltip-container","data-tooltip-container":"mirror"},es={class:"tooltip-container","data-tooltip-container":"theater"},ts={class:"material-symbols-outlined"},os={class:"custom-tooltip","data-tooltip":"theater"},ns={class:"tooltip-container","data-tooltip-container":"pip"},ss={class:"tooltip-container","data-tooltip-container":"aspect_ratio"},is={class:"current-ratio"},ls=["onClick"],as={key:0,class:"tooltip-container","data-tooltip-container":"app_link"},rs={class:"custom-tooltip","data-tooltip":"app_link"},cs={key:1,class:"tooltip-container","data-tooltip-container":"mpv"},us={class:"custom-tooltip","data-tooltip":"mpv"},ds={key:2,class:"tooltip-container","data-tooltip-container":"copy_link"},vs={class:"custom-tooltip","data-tooltip":"copy_link"},ps={key:3,class:"tooltip-container","data-tooltip-container":"overlay"},ms={class:"material-icons"},fs={key:0,class:"desktop-list-buttons"},gs={class:"tooltip-container"},ys={class:"material-icons"},hs={class:"custom-tooltip"},bs={class:"tooltip-container"},ws={class:"material-icons"},ks={class:"custom-tooltip"},xs={class:"tooltip-container"},Ss={class:"custom-tooltip"},Cs={class:"tooltip-container"},Is={class:"material-icons"},Es={class:"custom-tooltip"},Ts={class:"tooltip-container"},$s={class:"material-icons"},As={class:"custom-tooltip"},Ms={__name:"PlayerComponent",props:{kpId:String,movieInfo:{type:Object,default:()=>({})}},emits:["update:selectedPlayer","update:movieInfo"],setup(H,{emit:l}){const p=co(),r=vn(),h=Qo(),C=en(),D=uo(),$=f(C.params.kp_id),c=H,U=l,J=f([]),M=f(null),ie=f(!0),K=f(!1),F=f(!1),k=f(null),Ce=f(null),Ne=f(!1),g=f(!1),B=f([]),v=f(!1),O=f(""),z=f(""),Be=f(null),mt=f(window.innerHeight*.9),mo=ae(()=>"".concat(mt.value,"px")),ft=ae(()=>p.isMobile),E=ae(()=>!!window.electronAPI),Ht=ae(()=>p.contentApiProvider==="kinobd"&&!String(c.kpId||"").startsWith("shiki")),T=f(null),gt=f(!1);let St=null;const Ie=f(null),fo=f(null),go=f(null),me=f(null),je=f(!1),ke=f(!1),fe=f(null),Ct=f(null),yt=f(0),ce=f(null),Ee=f(null),xe=f(null),Ve=f(null),We=f(null),Te=f(null),V=ae({get:()=>r.videoOverlayEnabled2,set:t=>r.updateVideoOverlay(t)}),P=ae({get:()=>r.overlaySettings,set:t=>r.updateOverlaySettings(t)}),Vt=f(0),Wt=f(0),ze=f([]),st=f(!1);let Oe=null;const y=f(null),Xe=f(null),$e=f(!1),Z=f(null),Ae=f(!1),zt=f([]),Je=f([]),de=ae({get:()=>r.obsSettings,set:t=>r.updateObsSettings(t)}),It=t=>{const e=document.querySelector('[data-tooltip-container="'.concat(t,'"]')),o=document.querySelector('[data-tooltip="'.concat(t,'"]'));if(!e||!o)return;const s=e.getBoundingClientRect(),i=o.getBoundingClientRect(),m=window.innerHeight;s.bottom+i.height>m?(o.style.top="auto",o.style.bottom="100%",o.style.marginTop="0",o.style.marginBottom="12px",o.style.transform="translateX(-50%)"):(o.style.top="100%",o.style.bottom="auto",o.style.marginTop="12px",o.style.marginBottom="0",o.style.transform="translateX(-50%)")},le=t=>{T.value=t,gt.value=!1,clearTimeout(St),_t(()=>{It(t)})},Et=()=>{gt.value||(St=setTimeout(()=>{T.value=null},300))},Tt=()=>{gt.value=!0,clearTimeout(St)},ht=()=>{gt.value=!1,T.value=null},Re=ae({get:()=>r.aspectRatio,set:t=>r.updateAspectRatio(t)}),it=ae({get:()=>r.isCentered,set:t=>r.updateCentering(t)}),yo=ae(()=>{var t,e,o,s,i,m,_,w,a,b;return((e=(t=c.movieInfo)==null?void 0:t.lists)==null?void 0:e.isFavorite)||((s=(o=c.movieInfo)==null?void 0:o.lists)==null?void 0:s.isWatching)||((m=(i=c.movieInfo)==null?void 0:i.lists)==null?void 0:m.isLater)||((w=(_=c.movieInfo)==null?void 0:_.lists)==null?void 0:w.isCompleted)||((b=(a=c.movieInfo)==null?void 0:a.lists)==null?void 0:b.isAbandoned)}),Ut=ae(()=>r.preferredPlayer),ho=f(0),bt=t=>t.toUpperCase(),Kt=t=>{if(J.value=Object.entries(t||{}).map(([e,o])=>({key:e.toUpperCase(),...o})),J.value.length!==0){if(Ut.value){const e=bt(Ut.value),o=J.value.find(s=>bt(s.key)===e);M.value=o||J.value[0]}else M.value=J.value[0];U("update:selectedPlayer",M.value)}},$t=()=>{if(K.value||!Ce.value)return;const[t,e]=Re.value.split(":").map(Number);mt.value=window.innerHeight*.9,ho.value=Math.min(Ce.value.clientWidth*(e/t),mt.value)},bo=ae(()=>{if(K.value)return{};const[t,e]=Re.value.split(":").map(Number),o=mt.value*(t/e);return{width:"100%",maxWidth:"".concat(o,"px"),maxHeight:mo.value,margin:"0 auto",overflow:"hidden"}}),wo=ae(()=>{const[t,e]=Re.value.split(":").map(Number);return{position:"relative",width:"100%",paddingTop:"".concat(e/t*100,"%")}}),lt=()=>{Ce.value&&setTimeout(()=>{_t(()=>{Ce.value.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})})},500)},ko=async()=>{var t;try{z.value="",Be.value=null;let e;if(c.kpId.startsWith("shiki")){const o=c.kpId.replace("shiki","");e=await nn(o)}else{const o=((t=r.kinobdSourceByKpId)==null?void 0:t[String(c.kpId)])||null;e=await sn(c.kpId,{mode:"kp_id",usePlayerData:!0,forceInid:Ht.value?o:null})}Kt(e)}catch(e){const{message:o,code:s}=io(e);z.value=o,Be.value=s,console.error("Ошибка при загрузке плееров:",e)}},xo=()=>{Ne.value=!0},Gt=()=>{Ne.value=!1},So=async()=>{var t,e,o,s;g.value=!0,O.value="",v.value=!0;try{const i=((t=c.movieInfo)==null?void 0:t.title)||((e=c.movieInfo)==null?void 0:e.name_ru)||((o=c.movieInfo)==null?void 0:o.name_en)||((s=c.movieInfo)==null?void 0:s.name_original)||c.kpId;let m=[];i&&(m=await lo(i,{type:"title",page:1})),!m.length&&c.kpId&&(m=await lo(c.kpId,{type:"kp_id",page:1})),B.value=m}catch(i){O.value="Не удалось загрузить список источников",console.error("Ошибка при загрузке источников KinoBD:",i)}finally{v.value=!1}},At=()=>{g.value=!1},Co=async t=>{if(t!=null&&t.id){v.value=!0,O.value="";try{const e=await ln(t.id,{playerUrl:t.iframe});Kt(e),r.setKinoBdSource(c.kpId,t.id),At()}catch(e){O.value="Не удалось применить выбранный источник",console.error("Ошибка применения источника KinoBD:",e)}finally{v.value=!1}}},Io=()=>{try{return ce.value||(ce.value=new(window.AudioContext||window.webkitAudioContext)),Ee.value||(Ee.value=ce.value.createDynamicsCompressor(),Ee.value.threshold.value=-50,Ee.value.knee.value=40,Ee.value.ratio.value=12,Ee.value.attack.value=0,Ee.value.release.value=.25,Ve.value=ce.value.createGain(),We.value=ce.value.createGain(),Ve.value.gain.value=0,We.value.gain.value=1,Ee.value.connect(Ve.value),Ve.value.connect(ce.value.destination),We.value.connect(ce.value.destination)),!0}catch(t){return console.log("Error initializing audio context:",t),!1}},Eo=async t=>{try{if(!ce.value||Te.value===t)return!0;const e=k.value,o=(e==null?void 0:e.src)||"";if(o.includes("videoframe")||o.includes("kinoserial.net")||o.includes("allarknow"))return console.log("Player detected as unsupported for compressor:",o),Te.value=t,xe.value=null,ke.value=!1,E.value&&window.electronAPI.showToast("Компрессор не поддерживается этим плеером"),!1;if(xe.value)try{xe.value.disconnect()}catch(i){}const s=async(i=0)=>{i>0&&await new Promise(m=>setTimeout(m,i));try{return xe.value=ce.value.createMediaElementSource(t),Te.value=t,xe.value.connect(Ee.value),xe.value.connect(We.value),console.log("Video audio setup completed (attempt with ".concat(i,"ms delay)")),!0}catch(m){if(m.name==="InvalidStateError"&&m.message.includes("already connected"))return console.log("MediaElementSource already connected (".concat(i,"ms delay attempt)")),!1;throw m}};return await s(0)||await s(100)||await s(300)||await s(800)?!0:(console.log("Video element has internal audio processing, compressor not available for this player"),Te.value=t,xe.value=null,ke.value=!1,E.value&&window.electronAPI.showToast("Компрессор не поддерживается этим плеером"),!1)}catch(e){return console.log("Error setting up video audio:",e),!1}},Mt=async t=>{if(k.value)try{const e=k.value,o=e.contentDocument||e.contentWindow.document;if(!o)return;const s=o.querySelectorAll("video");if(s.length===0)return;const i=s[0];if(!Io())return;if(!await Eo(i)||!xe.value){console.log("Compressor not available for this player");return}t&&!ke.value?(Ve.value.gain.setValueAtTime(1,ce.value.currentTime),We.value.gain.setValueAtTime(0,ce.value.currentTime),ke.value=!0,E.value&&window.electronAPI.showToast("Компрессор включён"),console.log("Compressor enabled")):!t&&ke.value&&(Ve.value.gain.setValueAtTime(0,ce.value.currentTime),We.value.gain.setValueAtTime(1,ce.value.currentTime),ke.value=!1,E.value&&window.electronAPI.showToast("Компрессор отключён"),console.log("Compressor disabled"))}catch(e){console.log("Compressor error:",e),E.value&&window.electronAPI.showToast("Ошибка при включении компрессора")}},To=()=>{if(k.value)try{const t=k.value,e=t.contentDocument||t.contentWindow.document;if(!e)return;const o=e.querySelectorAll("video");if(o.length>0){const s=o[0];s.style.filter.includes("blur")||(s.style.filter="blur(50px)")}else t.style.filter.includes("blur")||(t.style.filter="blur(50px)")}catch(t){console.log("Error enabling blur:",t)}},$o=()=>{if(k.value)try{const t=k.value,e=t.contentDocument||t.contentWindow.document;if(!e)return;const o=e.querySelectorAll("video");if(o.length>0){const s=o[0];s.style.filter.includes("blur")&&(s.style.filter="")}else t.style.filter.includes("blur")&&(t.style.filter="")}catch(t){console.log("Error disabling blur:",t)}},Ao=()=>{if(E.value)try{const t=k.value,e=t.contentDocument||t.contentWindow.document;if(!e)return;const o=e.querySelectorAll("video");if(o.length>0){const s=o[0];s.style.filter.includes("blur")?s.style.filter="":s.style.filter="blur(50px)"}else t.style.filter.includes("blur")?t.style.filter="":t.style.filter="blur(50px)"}catch(t){console.log("Error toggling blur:",t)}else ot("Доступно только в приложении ReYohoho Desktop"),window.open("https://t.me/ReYohoho/126","_blank")},Yt=()=>{E.value?(Ue.value=!Ue.value,Mt(Ue.value)):(ot("Доступно только в приложении ReYohoho Desktop"),window.open("https://t.me/ReYohoho/126","_blank"))},jt=()=>{E.value?(Ze.value=!Ze.value,Bo(Ze.value)):(ot("Доступно только в приложении ReYohoho Desktop"),window.open("https://t.me/ReYohoho/126","_blank"))},wt=()=>{K.value=!K.value,K.value?(window.addEventListener("mousemove",Bt),document.addEventListener("keydown",Ft),document.body.classList.add("no-scroll")):(window.removeEventListener("mousemove",Bt),document.removeEventListener("keydown",Ft),document.body.classList.remove("no-scroll")),F.value=K.value,_t(()=>{lt(),k.value&&k.value.focus()})},Xt=f(null),Bt=()=>{Xt.value=setTimeout(()=>{clearTimeout(Xt.value),F.value=!1},4e3),F.value=!0},kt=ae(()=>p.dimmingEnabled),Mo=()=>{K.value||p.toggleDimming()},Ue=ae({get:()=>r.compressorEnabled,set:t=>r.updateCompressor(t)}),Ze=ae({get:()=>r.mirrorEnabled,set:t=>r.updateMirror(t)}),Bo=t=>{if(k.value)try{const e=k.value,o=e.contentDocument||e.contentWindow.document;if(!o)return;const s=o.querySelectorAll("video");if(s.length>0&&(s.forEach(i=>{t?i.style.transform="scaleX(-1)":i.style.transform="scaleX(1)"}),je.value=t,E.value)){const i=t?"Зеркало включено":"Зеркало отключено";window.electronAPI.showToast(i)}}catch(e){}},Fo=()=>{me.value&&clearInterval(me.value),me.value=setInterval(()=>{if(k.value)try{const t=k.value,e=t.contentDocument||t.contentWindow.document;if(!e)return;const o=e.querySelectorAll("video");if(o.length>0){const s=o[0],m=s.style.transform==="scaleX(-1)";Ze.value&&!m?(s.style.transform="scaleX(-1)",je.value=!0):!Ze.value&&m&&(s.style.transform="scaleX(1)",je.value=!1),Te.value!==s?(Te.value=null,ke.value=!1,Ue.value&&setTimeout(()=>{Mt(!0)},500)):Ue.value!==ke.value&&xe.value&&(console.log("Compressor state mismatch, reapplying"),Mt(Ue.value))}}catch(t){}},1e3)},Po=(t=!1)=>{if(!E.value)return;fe.value&&clearInterval(fe.value);let e=!1,o=[];function s(){var i;if(o=[],window.selectedNudityTimings&&Array.isArray(window.selectedNudityTimings)&&((i=c.movieInfo)!=null&&i.nudity_timings)){for(const m of c.movieInfo.nudity_timings)if(window.selectedNudityTimings.includes(m.id)){const _=ao(m.timing_text);_&&_.length>0&&o.push(..._)}}}s(),fe.value=setInterval(()=>{var i,m,_;if(k.value){s();try{const w=k.value,a=w.contentDocument||w.contentWindow.document;if(!a)return;const b=a.querySelectorAll("video");if(b.length>0){const A=b[0];if(Vt.value=A.currentTime||0,Wt.value=A.duration||0,E.value&&V.value&&!y.value&&!$e.value&&Date.now()-(window.iframeLoadTime||0)>=100)try{Qe(a,A)}catch(Q){console.log("Error creating overlay:",Q),$e.value=!1}if(E.value&&!V.value&&y.value&&setTimeout(()=>{!V.value&&y.value&&Le()},100),E.value&&((i=c.movieInfo)!=null&&i.nudity_timings)){const G=A.currentTime,Q=[],ve=[];if(window.overlayNudityTimings&&Array.isArray(window.overlayNudityTimings)&&window.overlayNudityTimings.length>0){for(const Y of c.movieInfo.nudity_timings)if(window.overlayNudityTimings.includes(Y.id)){const R=ao(Y.timing_text);if(R&&R.length>0){const W=[];for(const[ue,be]of R){let ne="normal";G>=ue&&G<=be?(ne="active",ve.push(Y.id)):ue>G&&ue-G<=5&&(ne="upcoming"),W.push({text:"[".concat(tt(ue),"-").concat(tt(be),"]"),status:ne})}Q.push({id:Y.id,intervals:W})}}}ze.value=Q,st.value=ve.length>0||Q.some(Y=>Y.intervals.some(R=>R.status==="upcoming"))}if(E.value&&y.value&&V.value&&oo(),!A.paused){const G=A.currentTime,Q=A.duration,ve=Q>0?G/Q*100:0;if(t&&(console.log("Video position: ".concat(G.toFixed(2),"s / ").concat(Q.toFixed(2),"s (").concat(ve.toFixed(1),"%)")),o.length>0)){const R=o.map(([W,ue])=>"".concat(tt(W)," - ").concat(tt(ue))).join(", ");console.log("Active blur intervals: [".concat(R,"]"))}let Y=!1;for(const[R,W]of o)if(G>=R&&G<=W){Y=!0;break}de.value.enabled&&Ae.value&&de.value.selectedFilterId?Y&&!e?((m=Z.value)==null||m.enableBlur(de.value.selectedFilterId),e=!0,console.log("OBS Blur applied at",G.toFixed(2),"seconds")):!Y&&e&&((_=Z.value)==null||_.disableBlur(de.value.selectedFilterId),e=!1,console.log("OBS Blur removed at",G.toFixed(2),"seconds")):Y&&!e&&E.value?(To(),e=!0,console.log("Blur applied at",G.toFixed(2),"seconds")):!Y&&e&&!de.value.enabled&&($o(),e=!1,console.log("Blur removed at",G.toFixed(2),"seconds"))}}}catch(w){console.log("Error monitoring video position:",w)}}},100)},No=()=>{ie.value=!1,window.iframeLoadTime=Date.now(),Fo(),Po(),E.value&&V.value&&!y.value&&setTimeout(()=>{try{const t=k.value,e=t.contentDocument||t.contentWindow.document;if(e){const o=e.querySelector("video");o&&Qe(e,o)}}catch(t){console.log("Error creating overlay on iframe load:",t),$e.value=!1}},100)},Ft=t=>{(t.key==="Escape"&&K.value||t.altKey&&t.keyCode===84)&&wt()},Jt=t=>{Re.value=t,setTimeout(()=>{it.value&&lt()},310)},Oo=()=>{const t="reyohoho://#".concat($.value);try{window.location.href=t}catch(e){console.error("Ошибка при открытии ссылки:",e)}},Ro=t=>{if(!t)return"";const o=[t.hls,t.stream,t.url,t.file,t.src].filter(m=>typeof m=="string"&&m).find(m=>/\.m3u8(\?|$)/i.test(m)||/manifest/i.test(m)||/\/hls\//i.test(m));if(o)return o;const s=t.raw_data;if(s&&typeof s=="object"){const m=[s],_=new Set;for(;m.length;){const w=m.shift();if(!(!w||typeof w!="object")&&!_.has(w)){_.add(w);for(const a of Object.values(w))if(a)if(typeof a=="string"){if(/^https?:\/\//i.test(a)&&(/\.m3u8(\?|$)/i.test(a)||/manifest/i.test(a)||/\/hls\//i.test(a)))return a}else typeof a=="object"&&m.push(a)}}}const i=String(t.iframe||"");if(!i)return"";try{const m=new URL(i),_=[];m.searchParams.forEach(w=>_.push(w));for(const w of _)if(/^https?:\/\//i.test(w)&&/\.m3u8(\?|$)/i.test(w))return w}catch(m){return""}return""},Zt=async t=>{if(!t)return!1;try{return await navigator.clipboard.writeText(t),!0}catch(e){return!1}},Lo=async()=>{const t=M.value;if(!t)return;const o=Ro(t)||String(t.iframe||"");if(!o){Ie.value.showNotification("Не удалось получить ссылку для mpv");return}const s=(()=>{try{const w=new URL(String(t.iframe||""));return"".concat(w.origin,"/")}catch(w){return""}})(),i=s?'mpv --referrer="'.concat(s,'" "').concat(o,'"'):'mpv "'.concat(o,'"');if(await Zt(i)){Ie.value.showNotification("Команда mpv скопирована");return}if(await Zt(o)){Ie.value.showNotification("Ссылка для mpv скопирована");return}Ie.value.showNotification("Не удалось скопировать ссылку для mpv")},_o=()=>{const t=window.location.href;navigator.clipboard.writeText(t).then(()=>{}),Ie.value.showNotification("Ссылка на фильм скопирована")};function Qt(t){return t.replace(/KODIK>/,"Kodik - ").replace(/VEOVEO>/,"VeoVeo - ").trim()}const Do=()=>{try{xe.value&&(xe.value.disconnect(),xe.value=null),ce.value&&(ce.value.close(),ce.value=null),Ee.value=null,Ve.value=null,We.value=null,Te.value=null,ke.value=!1}catch(t){console.log("Error cleaning up audio context:",t)}},qo=t=>{var e;if(((e=M.value)==null?void 0:e.key)===t.key){Gt();return}M.value=t,ie.value=!0,je.value=!1,ke.value=!1,Te.value=null,y.value&&Le(),me.value&&(clearInterval(me.value),me.value=null),fe.value&&(clearInterval(fe.value),fe.value=null),t.key.toLowerCase().includes("torrents")||r.updatePreferredPlayer(bt(t.key)),U("update:selectedPlayer",t)};et(M,t=>{t&&(ie.value=!0,je.value=!1,ke.value=!1,Te.value=null,y.value&&Le(),me.value&&(clearInterval(me.value),me.value=null),fe.value&&(clearInterval(fe.value),fe.value=null),t.key.toLowerCase().includes("torrents")||r.updatePreferredPlayer(bt(t.key)),U("update:selectedPlayer",t))}),et(()=>C.params.kp_id,async t=>{t&&t!==$.value&&($.value=t,je.value=!1,ke.value=!1,Te.value=null,y.value&&Le(),me.value&&(clearInterval(me.value),me.value=null),fe.value&&(clearInterval(fe.value),fe.value=null),yt.value=0,it.value&&lt())},{immediate:!0}),et(V,t=>{if(E.value)if(t&&!y.value){const e=()=>{if(k.value)try{const o=k.value,s=o.contentDocument||o.contentWindow.document;if(s){const i=s.querySelector("video");if(i){const m=Date.now()-(window.iframeLoadTime||0);m>=100?Qe(s,i):setTimeout(e,100-m)}}}catch(o){console.log("Error creating overlay via watcher:",o),$e.value=!1}};e()}else!t&&y.value&&Le()}),et(ze,(t,e)=>{if(!E.value)return;const o=e&&e.length>0,s=t&&t.length>0;!o&&s&&(V.value||(V.value=!0,window.electronAPI&&window.electronAPI.showToast("Оверлей автоматически включён - добавлены тайминги")))},{deep:!0}),et(()=>de.value.enabled,t=>{t&&!Ae.value?Nt():!t&&Ae.value&&to()}),et(P,(t,e)=>{!E.value||!V.value||(e&&t.showBackground!==e.showBackground?y.value&&(Le(),setTimeout(()=>{if(k.value&&V.value)try{const o=k.value,s=o.contentDocument||o.contentWindow.document;if(s){const i=s.querySelector("video");i&&Qe(s,i)}}catch(o){console.log("Error recreating overlay:",o)}},100)):y.value&&oo())},{deep:!0});const xt=["16:9","12:5","4:3"],Ho=()=>{const e=(xt.indexOf(Re.value)+1)%xt.length;Jt(xt[e])},Vo=t=>{var o,s,i,m,_,w,a,b,A,G,Q,ve,Y;return(Y={[X.FAVORITE]:((s=(o=c.movieInfo)==null?void 0:o.lists)==null?void 0:s.isFavorite)||!1,[X.HISTORY]:((m=(i=c.movieInfo)==null?void 0:i.lists)==null?void 0:m.isHistory)||!1,[X.LATER]:((w=(_=c.movieInfo)==null?void 0:_.lists)==null?void 0:w.isLater)||!1,[X.COMPLETED]:((b=(a=c.movieInfo)==null?void 0:a.lists)==null?void 0:b.isCompleted)||!1,[X.ABANDONED]:((G=(A=c.movieInfo)==null?void 0:A.lists)==null?void 0:G.isAbandoned)||!1,[X.WATCHING]:((ve=(Q=c.movieInfo)==null?void 0:Q.lists)==null?void 0:ve.isWatching)||!1}[t])!=null?Y:!1},Se=async t=>{if(!h.token){Ie.value.showNotification('Необходимо <a class="auth-link">авторизоваться</a>',5e3,{onClick:Wo});return}try{const e={[X.FAVORITE]:"избранное",[X.HISTORY]:"историю",[X.LATER]:'список "Смотреть позже"',[X.COMPLETED]:'список "Просмотрено"',[X.ABANDONED]:'список "Брошено"',[X.WATCHING]:'список "Смотрю"'};Vo(t)?(await an($.value,t),Ie.value.showNotification("Удалено из ".concat(e[t]))):(await rn($.value,t),Ie.value.showNotification("Добавлено в ".concat(e[t])))}catch(e){const{message:o,code:s}=io(e);Ie.value.showNotification("".concat(o," ").concat(s))}U("update:movieInfo")},Wo=()=>{D.push("/login")},Pt=ae(()=>r.showFavoriteTooltip),zo=()=>{D.push("/settings"),ht()},Uo=async()=>{if(!E.value){ot("Доступно только в приложении ReYohoho Desktop"),window.open("https://t.me/ReYohoho/126","_blank");return}if(k.value)try{const t=k.value,e=t.contentDocument||t.contentWindow.document;if(!e)return;const o=e.querySelector("video");if(!o)return;document.pictureInPictureElement?await document.exitPictureInPicture():document.pictureInPictureEnabled?await o.requestPictureInPicture():ot('Ваш браузер не поддерживает режим "Картинка в картинке"')}catch(t){console.error("Error toggling PiP:",t),ot('Не удалось включить режим "Картинка в картинке"')}},Ko=()=>{if(V.value=!V.value,!V.value)Le();else{const t=()=>{if(!y.value&&k.value)try{const e=k.value,o=e.contentDocument||e.contentWindow.document;if(o){const s=o.querySelector("video");if(s){const i=Date.now()-(window.iframeLoadTime||0);i>=100?Qe(o,s):setTimeout(t,100-i)}}}catch(e){console.log("Error creating overlay:",e),$e.value=!1}};t()}},eo=()=>{Z.value&&Z.value.disconnect(),Z.value=new En,Z.value.setCallbacks({onConnect:()=>{Ae.value=!0,r.setObsConnected(!0),E.value&&window.electronAPI&&window.electronAPI.showToast("Подключен к OBS WebSocket")},onDisconnect:()=>{Ae.value=!1,r.setObsConnected(!1),zt.value=[],Je.value=[]},onSourcesUpdated:t=>{zt.value=t,window.obsSources=t},onFiltersFound:t=>{Je.value=t,window.obsFiltersFound=t,r.updateObsSettings({filtersFound:t})},onError:t=>{console.error("OBS WebSocket error:",t),E.value&&window.electronAPI&&window.electronAPI.showToast("Ошибка OBS: ".concat(t))}})},Nt=async()=>{Z.value||eo(),await Z.value.connect(de.value.host,de.value.port,de.value.password)},to=()=>{Z.value&&Z.value.disconnect()},Go=t=>{Z.value&&Ae.value&&t?Z.value.testBlur(t):E.value&&window.electronAPI&&window.electronAPI.showToast("Фильтр не выбран или не найден в OBS")},Yo=()=>{Z.value&&Ae.value&&Z.value.loadSourcesAndSearchFilters()},jo=()=>Je.value,Xo=()=>{try{document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen();const t=k.value;if(t){const e=t.contentDocument||t.contentWindow.document;if(e){e.exitFullscreen?e.exitFullscreen():e.webkitExitFullscreen?e.webkitExitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.msExitFullscreen&&e.msExitFullscreen();const o=e.querySelector("video");o&&(o.webkitExitFullscreen?o.webkitExitFullscreen():o.exitFullscreen&&o.exitFullscreen())}}}catch(t){console.log("Error exiting fullscreen:",t)}},Jo=()=>{if(!E.value)return;const t=k.value,e=t.contentDocument||t.contentWindow.document;if(!e||e.getElementById("overlay-settings-modal"))return;const o=P.value,s=e.createElement("div");s.id="overlay-settings-modal",s.style.cssText="\n    position: fixed !important;\n    top: 0 !important;\n    left: 0 !important;\n    width: 100% !important;\n    height: 100% !important;\n    background: rgba(0, 0, 0, 0.8) !important;\n    display: flex !important;\n    align-items: center !important;\n    justify-content: center !important;\n    z-index: 9999 !important;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;\n  ";const i=e.createElement("div");i.style.cssText="\n    background: rgba(30, 30, 30, 0.95) !important;\n    backdrop-filter: blur(20px) !important;\n    border-radius: 16px !important;\n    padding: 32px !important;\n    max-width: 400px !important;\n    width: 90% !important;\n    border: 1px solid rgba(255, 255, 255, 0.1) !important;\n    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5) !important;\n  ",i.innerHTML='\n    <h3 style="color: #ff6b35; margin: 0 0 24px 0; font-size: 20px; font-weight: 600; text-align: center;">Настройки оверлея</h3>\n    \n    <div style="display: flex; flex-direction: column; gap: 16px;">\n      <label style="display: flex; align-items: center; gap: 12px; color: white; cursor: pointer; padding: 8px; border-radius: 8px; background: rgba(255, 255, 255, 0.05);">\n        <input type="checkbox" id="showTitle" '.concat(o.showTitle?"checked":"",' style="width: 18px; height: 18px; accent-color: #ff6b35;">\n        <span style="font-size: 16px;">Показывать название фильма</span>\n      </label>\n      \n      <label style="display: flex; align-items: center; gap: 12px; color: white; cursor: pointer; padding: 8px; border-radius: 8px; background: rgba(255, 255, 255, 0.05);">\n        <input type="checkbox" id="showDuration" ').concat(o.showDuration2?"checked":"",' style="width: 18px; height: 18px; accent-color: #ff6b35;">\n        <span style="font-size: 16px;">Показывать продолжительность</span>\n      </label>\n      \n      <label style="display: flex; align-items: center; gap: 12px; color: white; cursor: pointer; padding: 8px; border-radius: 8px; background: rgba(255, 255, 255, 0.05);">\n        <input type="checkbox" id="showBackground" ').concat(o.showBackground?"checked":"",' style="width: 18px; height: 18px; accent-color: #ff6b35;">\n        <span style="font-size: 16px;">Показывать затемненный фон</span>\n      </label>\n      \n      <label style="display: flex; align-items: center; gap: 12px; color: white; cursor: pointer; padding: 8px; border-radius: 8px; background: rgba(255, 255, 255, 0.05);">\n        <input type="checkbox" id="showTimingsOnMouseMove" ').concat(o.showTimingsOnMouseMove?"checked":"",' style="width: 18px; height: 18px; accent-color: #ff6b35;">\n        <span style="font-size: 16px;">Показывать тайминги только при движении мышки</span>\n      </label>\n      \n      <label style="display: flex; align-items: center; gap: 12px; color: white; cursor: pointer; padding: 8px; border-radius: 8px; background: rgba(255, 255, 255, 0.05);">\n        <input type="checkbox" id="highlightTimings" ').concat(o.highlightTimings?"checked":"",' style="width: 18px; height: 18px; accent-color: #ff6b35;">\n        <span style="font-size: 16px;">Подсвечивать близкие и текущие тайминги</span>\n      </label>\n\n    </div>\n    \n    <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: center;">\n      <button id="saveSettings" style="background: #ff6b35; color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.3s ease;">\n        Сохранить\n      </button>\n      <button id="cancelSettings" style="background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 10px 16px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">\n        Отмена\n      </button>\n    </div>\n  '),["click","mousedown","mouseup","mousemove","wheel","contextmenu"].forEach(a=>{i.addEventListener(a,b=>{b.stopPropagation(),b.stopImmediatePropagation()})}),s.appendChild(i),s.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),a.target===s&&s.remove()}),["mousedown","mouseup","mousemove","wheel","contextmenu"].forEach(a=>{s.addEventListener(a,b=>{b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation()})}),i.querySelector("#saveSettings").addEventListener("click",a=>{var A;a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation();const b={showTitle:i.querySelector("#showTitle").checked,showDuration2:i.querySelector("#showDuration").checked,showBackground:i.querySelector("#showBackground").checked,showTimingsOnMouseMove:i.querySelector("#showTimingsOnMouseMove").checked,highlightTimings:i.querySelector("#highlightTimings").checked};P.value=b,(A=window.electronAPI)==null||A.showToast("Настройки оверлея сохранены"),s.remove()}),i.querySelector("#cancelSettings").addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),s.remove()}),i.querySelectorAll("button").forEach(a=>{a.addEventListener("mouseenter",b=>{b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation(),a.id==="saveSettings"?(a.style.background="#e55a2b",a.style.transform="translateY(-1px)"):a.style.background="rgba(255, 255, 255, 0.15)"}),a.addEventListener("mouseleave",b=>{b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation(),a.id==="saveSettings"?(a.style.background="#ff6b35",a.style.transform="translateY(0)"):a.style.background="rgba(255, 255, 255, 0.1)"}),["mousedown","mouseup","mousemove","wheel","contextmenu"].forEach(b=>{a.addEventListener(b,A=>{A.preventDefault(),A.stopPropagation(),A.stopImmediatePropagation()})})});const _=i.querySelectorAll('input[type="checkbox"]'),w=i.querySelectorAll("label");_.forEach(a=>{["click","mousedown","mouseup","mousemove","wheel","contextmenu"].forEach(b=>{a.addEventListener(b,A=>{b!=="click"?(A.preventDefault(),A.stopPropagation(),A.stopImmediatePropagation()):A.stopPropagation()})})}),w.forEach(a=>{["mousedown","mouseup","mousemove","wheel","contextmenu"].forEach(b=>{a.addEventListener(b,A=>{A.preventDefault(),A.stopPropagation(),A.stopImmediatePropagation()})})}),e.body.appendChild(s)},Qe=(t,e)=>{if(!V.value||y.value||$e.value)return;$e.value=!0;const o=t.createElement("div");o.id="reyohoho-video-overlay";let s=()=>{o.style.cssText="\n      position: absolute !important;\n      top: 0 !important;\n      left: 0 !important;\n      width: 100% !important;\n      height: 100% !important;\n      pointer-events: none !important;\n      z-index: 999999999 !important;\n      display: flex !important;\n      flex-direction: column !important;\n      justify-content: space-between !important;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;\n      visibility: visible !important;\n      opacity: 1 !important;\n    "};const i=t.createElement("div");i.style.cssText="\n    color: white !important;\n    padding: 20px !important;\n    text-align: left !important;\n    pointer-events: none !important;\n  ";const m=t.createElement("div"),_=P.value.showBackground?"rgba(0, 0, 0, 0.7)":"transparent",w=P.value.showBackground?"blur(10px)":"none",a=P.value.showBackground?"fit-content":"auto",b=P.value.fontSize||18;m.style.cssText="\n    font-size: ".concat(b+2,"px !important;\n    font-weight: 600 !important;\n    margin-bottom: 8px !important;\n    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;\n    line-height: 1.2 !important;\n    padding: 8px 12px !important;\n    border-radius: 6px !important;\n    display: inline-block !important;\n    color: rgba(255, 255, 255, 0.6) !important;\n    background: ").concat(_," !important;\n    backdrop-filter: ").concat(w," !important;\n    width: ").concat(a," !important;\n  ");const A=t.createElement("div"),G=P.value.showBackground?"rgba(0, 0, 0, 0.7)":"transparent",Q=P.value.showBackground?"blur(10px)":"none",ve=P.value.showBackground?"6px":"0",Y=P.value.showBackground?"inline-flex":"flex",R=P.value.showBackground?"fit-content":"auto";A.style.cssText="\n    font-size: ".concat(b,"px !important;\n    font-weight: 500 !important;\n    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;\n    display: ").concat(Y," !important;\n    align-items: center !important;\n    gap: 8px !important;\n    flex-wrap: wrap !important;\n    color: rgba(255, 255, 255, 0.6) !important;\n    margin-left: 12px !important;\n    background: ").concat(G," !important;\n    backdrop-filter: ").concat(Q," !important;\n    border-radius: ").concat(ve," !important;\n    width: ").concat(R," !important;\n  ");const W=t.createElement("div"),ue=P.value.showBackground?"rgba(0, 0, 0, 0.7)":"transparent",be=P.value.showBackground?"blur(10px)":"none";W.style.cssText="\n    position: absolute !important;\n    top: 20px !important;\n    right: 110px !important;\n    background: ".concat(ue," !important;\n    backdrop-filter: ").concat(be," !important;\n    border-radius: 12px !important;\n    padding: 16px !important;\n    width: fit-content !important;\n    max-width: 800px !important;\n    pointer-events: none !important;\n    display: none !important;\n    transition: opacity 0.3s ease, visibility 0.3s ease !important;\n    opacity: 0 !important;\n    visibility: hidden !important;\n  ");const ne=t.createElement("div");ne.style.cssText="\n    font-size: ".concat(b-4,"px !important;\n    color: rgba(255, 255, 255, 0.6) !important;\n    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8) !important;\n    line-height: 1.4 !important;\n    word-wrap: break-word !important;\n  ");const j=t.createElement("div");j.style.cssText="\n    position: absolute !important;\n    top: 20px !important;\n    right: 20px !important;\n    display: flex !important;\n    gap: 8px !important;\n    pointer-events: all !important;\n  ";const re=t.createElement("button");re.style.cssText="\n    background: rgba(0, 0, 0, 0.8) !important;\n    backdrop-filter: blur(10px) !important;\n    color: white !important;\n    border: 1px solid rgba(255, 255, 255, 0.2) !important;\n    border-radius: 50% !important;\n    width: 40px !important;\n    height: 40px !important;\n    display: flex !important;\n    align-items: center !important;\n    justify-content: center !important;\n    cursor: pointer !important;\n    transition: all 0.3s ease !important;\n    font-size: 18px !important;\n  ",re.innerHTML="⚙️",re.title="Настройки оверлея";const we=t.createElement("button");we.style.cssText="\n    background: rgba(0, 0, 0, 0.8) !important;\n    backdrop-filter: blur(10px) !important;\n    color: white !important;\n    border: 1px solid rgba(255, 255, 255, 0.2) !important;\n    border-radius: 50% !important;\n    width: 40px !important;\n    height: 40px !important;\n    display: flex !important;\n    align-items: center !important;\n    justify-content: center !important;\n    cursor: pointer !important;\n    transition: all 0.3s ease !important;\n    font-size: 20px !important;\n    font-weight: bold !important;\n  ",we.innerHTML="A-",we.title="Уменьшить шрифт";const Fe=t.createElement("button");Fe.style.cssText="\n    background: rgba(0, 0, 0, 0.8) !important;\n    backdrop-filter: blur(10px) !important;\n    color: white !important;\n    border: 1px solid rgba(255, 255, 255, 0.2) !important;\n    border-radius: 50% !important;\n    width: 40px !important;\n    height: 40px !important;\n    display: flex !important;\n    align-items: center !important;\n    justify-content: center !important;\n    cursor: pointer !important;\n    transition: all 0.3s ease !important;\n    font-size: 20px !important;\n    font-weight: bold !important;\n  ",Fe.innerHTML="A+",Fe.title="Увеличить шрифт";const Pe=t.createElement("button");Pe.style.cssText="\n    background: rgba(0, 0, 0, 0.8) !important;\n    backdrop-filter: blur(10px) !important;\n    color: white !important;\n    border: 1px solid rgba(255, 255, 255, 0.2) !important;\n    border-radius: 50% !important;\n    width: 40px !important;\n    height: 40px !important;\n    display: flex !important;\n    align-items: center !important;\n    justify-content: center !important;\n    cursor: pointer !important;\n    transition: all 0.3s ease !important;\n    font-size: 18px !important;\n  ",Pe.innerHTML="👁️",Pe.title="Отключить оверлей",Pe.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation(),V.value=!1}),re.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation(),Xo(),setTimeout(()=>{Jo()},100)}),we.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation();const N=P.value.fontSize||18;N>10&&(P.value={...P.value,fontSize:N-2})}),Fe.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation();const N=P.value.fontSize||18;N<36&&(P.value={...P.value,fontSize:N+2})}),[re,Pe,we,Fe].forEach(u=>{u.addEventListener("mouseenter",N=>{N.preventDefault(),N.stopPropagation(),N.stopImmediatePropagation(),u.style.background="#ff6b35",u.style.borderColor="#ff6b35",u.style.transform="scale(1.1)"}),u.addEventListener("mouseleave",N=>{N.preventDefault(),N.stopPropagation(),N.stopImmediatePropagation(),u.style.background="rgba(0, 0, 0, 0.8)",u.style.borderColor="rgba(255, 255, 255, 0.2)",u.style.transform="scale(1)"}),["mousedown","mouseup","mousemove","wheel","contextmenu"].forEach(N=>{u.addEventListener(N,L=>{L.preventDefault(),L.stopPropagation(),L.stopImmediatePropagation()})})}),["click","mousedown","mouseup","mousemove","wheel","contextmenu"].forEach(u=>{j.addEventListener(u,N=>{N.preventDefault(),N.stopPropagation(),N.stopImmediatePropagation()})}),j.appendChild(we),j.appendChild(Fe),j.appendChild(re),j.appendChild(Pe),W.appendChild(ne),i.appendChild(m),i.appendChild(A),o.appendChild(i),o.appendChild(W),o.appendChild(j),j.style.transition="opacity 0.3s ease, visibility 0.3s ease",j.style.opacity="0",j.style.visibility="hidden",i.style.transition="opacity 0.3s ease";let Ke=null;const at=()=>{j.style.opacity="1",j.style.visibility="visible",i.style.opacity="0",P.value.showTimingsOnMouseMove&&ze.value.length>0&&(W.style.opacity="1",W.style.visibility="visible",clearTimeout(Oe),Oe=null,st.value||(Oe=setTimeout(()=>{W.style.opacity="0",W.style.visibility="hidden",Oe=null},3e3))),clearTimeout(Xe.value),clearTimeout(Ke),Xe.value=setTimeout(()=>{j.style.opacity="0",j.style.visibility="hidden"},3e3),Ke=setTimeout(()=>{i.style.opacity="1"},2e3)};t.addEventListener("mousemove",at),o.addEventListener("mouseenter",()=>{j.style.opacity="1",j.style.visibility="visible",i.style.opacity="0",clearTimeout(Ke)}),o.addEventListener("mouseleave",()=>{clearTimeout(Xe.value),clearTimeout(Ke),j.style.opacity="0",j.style.visibility="hidden",i.style.opacity="1"}),o._mouseHandler=at;const _e=(u=>{if(document.fullscreenElement===u||document.webkitFullscreenElement===u||u.webkitDisplayingFullscreen||u.offsetWidth===window.screen.width&&u.offsetHeight===window.screen.height)return t.body||t.documentElement;let L=u.parentNode,ge=0;const Me=5;for(;L&&ge<Me;){const pe=t.defaultView.getComputedStyle(L),se=L.getBoundingClientRect();if(se.width>0&&se.height>0&&(pe.position==="relative"||pe.position==="absolute"||pe.position==="fixed"||L.tagName==="BODY"))return L;L=L.parentNode,ge++}return u.parentNode})(e);o._targetContainer=_e,o._videoElement=e,s=()=>{const u=o._videoElement,N=o._targetContainer;if(document.fullscreenElement===u||document.webkitFullscreenElement===u||u.webkitDisplayingFullscreen||u.offsetWidth===window.screen.width&&u.offsetHeight===window.screen.height)o.style.cssText="\n        position: fixed !important;\n        top: 0 !important;\n        left: 0 !important;\n        width: 100vw !important;\n        height: 100vh !important;\n        pointer-events: none !important;\n        z-index: 999999999 !important;\n        display: flex !important;\n        flex-direction: column !important;\n        justify-content: space-between !important;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;\n        visibility: visible !important;\n        opacity: 1 !important;\n        box-sizing: border-box !important;\n      ";else{const ge=t.defaultView.getComputedStyle(u),Me=N.getBoundingClientRect(),pe=u.offsetWidth||u.clientWidth||parseFloat(ge.width)||0,se=u.offsetHeight||u.clientHeight||parseFloat(ge.height)||0,qe=u.getBoundingClientRect(),ye=qe.top-Me.top+N.scrollTop,Ge=qe.left-Me.left+N.scrollLeft;o.style.cssText="\n        position: absolute !important;\n        top: ".concat(ye,"px !important;\n        left: ").concat(Ge,"px !important;\n        width: ").concat(pe,"px !important;\n        height: ").concat(se,"px !important;\n        pointer-events: none !important;\n        z-index: 999999999 !important;\n        display: flex !important;\n        flex-direction: column !important;\n        justify-content: space-between !important;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;\n        visibility: visible !important;\n        opacity: 1 !important;\n        box-sizing: border-box !important;\n      ")}},e.style.position="relative",(_e.style.position===""||_e.style.position==="static")&&(_e.style.position="relative"),_e.appendChild(o),s(),y.value=o,$e.value=!1;const rt=setInterval(()=>{if(!y.value||!V.value){clearInterval(rt);return}if(!t.body.contains(o))try{const L=t.querySelectorAll("video");if(L.length>0){const ge=L[0];o._videoElement=ge;const pe=(se=>{if(document.fullscreenElement===se||document.webkitFullscreenElement===se||se.webkitDisplayingFullscreen||se.offsetWidth===window.screen.width&&se.offsetHeight===window.screen.height)return t.body||t.documentElement;let ye=se.parentNode,Ge=0;const d=5;for(;ye&&Ge<d;){const vt=t.defaultView.getComputedStyle(ye),no=ye.getBoundingClientRect();if(no.width>0&&no.height>0&&(vt.position==="relative"||vt.position==="absolute"||vt.position==="fixed"||ye.tagName==="BODY"))return ye;ye=ye.parentNode,Ge++}return se.parentNode})(ge);o._targetContainer=pe,pe.appendChild(o),s(),o._mouseHandler&&(t.removeEventListener("mousemove",o._mouseHandler),t.addEventListener("mousemove",o._mouseHandler))}}catch(L){console.log("Error re-adding overlay to DOM:",L)}const u=t.defaultView.getComputedStyle(o);if((u.visibility==="hidden"||u.display==="none"||u.opacity==="0")&&s(),(parseInt(u.zIndex)||0)<999999999&&s(),o._videoElement&&o._targetContainer){const L=o._videoElement,ge=t.defaultView.getComputedStyle(L),Me=document.fullscreenElement===L||document.webkitFullscreenElement===L||L.webkitDisplayingFullscreen||L.offsetWidth===window.screen.width&&L.offsetHeight===window.screen.height;let pe,se;Me?(pe=window.innerWidth,se=window.innerHeight):(pe=L.offsetWidth||L.clientWidth||parseFloat(ge.width)||0,se=L.offsetHeight||L.clientHeight||parseFloat(ge.height)||0);const qe=parseInt(u.width)||0,ye=parseInt(u.height)||0;(Math.abs(qe-pe)>5||Math.abs(ye-se)>5)&&s()}},1e3),ct=new window.MutationObserver(u=>{u.forEach(N=>{N.type==="attributes"&&N.target===o&&N.attributeName==="style"&&setTimeout(()=>{y.value&&V.value&&s()},100)})});ct.observe(o,{attributes:!0,attributeFilter:["style","class"]});const ut=()=>{y.value&&V.value&&s()},De=()=>{y.value&&V.value&&setTimeout(()=>{s()},100)};t.defaultView.addEventListener("resize",ut),t.addEventListener("fullscreenchange",De),t.addEventListener("webkitfullscreenchange",De),e.addEventListener("webkitbeginfullscreen",De),e.addEventListener("webkitendfullscreen",De),o._monitorInterval=rt,o._mutationObserver=ct,o._resizeHandler=ut,o._fullscreenHandler=De,o._iframeDoc=t;const dt=setInterval(()=>{if(!y.value||!V.value){clearInterval(dt);return}s()},500);setTimeout(()=>{clearInterval(dt)},1e4)},oo=()=>{var A,G,Q,ve,Y;if(!y.value||!V.value)return;const t=k.value;if(!t)return;const e=t.contentDocument||t.contentWindow.document;if(!e)return;const o=y.value,s=o.children[0],i=o.children[1],m=e.defaultView.getComputedStyle(o);(m.display==="none"||m.visibility==="hidden")&&(o.style.display="flex !important",o.style.visibility="visible !important");const _=P.value.fontSize||18,w=s.children[0];if(w.style.fontSize="".concat(_+2,"px"),P.value.showTitle){w.style.display="block";const R=((A=c.movieInfo)==null?void 0:A.title)||((G=c.movieInfo)==null?void 0:G.name_ru)||((Q=c.movieInfo)==null?void 0:Q.name_en)||((ve=c.movieInfo)==null?void 0:ve.name_original)||"Загрузка...",W=(Y=c.movieInfo)!=null&&Y.year?" (".concat(c.movieInfo.year,")"):"";w.textContent=R+W,P.value.showBackground?(w.style.background="rgba(0, 0, 0, 0.7) !important",w.style.backdropFilter="blur(10px) !important",w.style.width="fit-content !important",w.style.display="inline-block !important"):(w.style.background="transparent !important",w.style.backdropFilter="none !important",w.style.width="auto !important",w.style.display="inline-block !important")}else w.style.display="none";const a=s.children[1];a.style.fontSize="".concat(_,"px");let b="";if(P.value.showDuration2){const R=tt(Vt.value),W=tt(Wt.value);b="\n      <span style=\"font-family: 'Courier New', monospace; color: rgba(255, 255, 255, 0.6);\">".concat(R,'</span>\n      <span style="opacity: 0.6;">/</span>\n      <span style="font-family: \'Courier New\', monospace; color: rgba(255, 255, 255, 0.6);">').concat(W,"</span>\n    ")}if(de.value.enabled&&de.value.showObsInOverlay){let R="Отключен";const W="#999999";if(Ae.value)if(de.value.selectedFilterId){const be=Je.value.find(ne=>ne.id===de.value.selectedFilterId);be?R="".concat(be.filterName," (").concat(be.sceneName,")"):R="Фильтр не найден"}else Je.value.length>0?R="Фильтр не выбран":R="Фильтры не найдены";const ue='\n      <span style="color: '.concat(W,';">\n        OBS: ').concat(R,"\n      </span>\n    ");b=b?"".concat(b," ").concat(ue):ue}if(b?(a.style.display="flex",a.innerHTML=b,P.value.showBackground?(a.style.background="rgba(0, 0, 0, 0.7) !important",a.style.backdropFilter="blur(10px) !important",a.style.borderRadius="6px !important",a.style.padding="8px 12px !important",a.style.width="fit-content !important",a.style.display="inline-flex !important"):(a.style.background="transparent !important",a.style.backdropFilter="none !important",a.style.borderRadius="0 !important",a.style.padding="0 !important",a.style.width="auto !important",a.style.display="flex !important")):a.style.display="none",ze.value.length>0){const R=i.children[0];R.style.fontSize="".concat(_-4,"px"),R.innerHTML="";const W=e.createElement("span");W.textContent="Тайминги: ",W.style.color="rgba(255, 255, 255, 0.6)",R.appendChild(W),ze.value.forEach((ue,be)=>{if(be>0){const ne=e.createElement("span");ne.textContent=", ",ne.style.color="rgba(255, 255, 255, 0.6)",R.appendChild(ne)}ue.intervals.forEach((ne,j)=>{if(j>0){const we=e.createElement("span");we.textContent=", ",we.style.color="rgba(255, 255, 255, 0.6)",R.appendChild(we)}const re=e.createElement("span");re.textContent=ne.text,ne.status==="active"&&P.value.highlightTimings?(re.style.color="#ff4444",re.style.fontWeight="bold"):ne.status==="upcoming"&&P.value.highlightTimings?(re.style.color="#ff6b35",re.style.fontWeight="500"):re.style.color="rgba(255, 255, 255, 0.6)",R.appendChild(re)})}),i.style.display="block",(!P.value.showTimingsOnMouseMove||st.value)&&(i.style.opacity="1",i.style.visibility="visible"),P.value.showBackground?(i.style.background="rgba(0, 0, 0, 0.7) !important",i.style.backdropFilter="blur(10px) !important",i.style.width="fit-content !important",i.style.minWidth="auto !important"):(i.style.background="transparent !important",i.style.backdropFilter="none !important",i.style.width="fit-content !important",i.style.minWidth="auto !important")}else i.style.display="none";P.value.showTimingsOnMouseMove&&st.value&&ze.value.length>0?(i.style.opacity="1",i.style.visibility="visible",clearTimeout(Oe)):P.value.showTimingsOnMouseMove&&!st.value&&ze.value.length>0&&i.style.opacity==="1"&&!Oe&&(Oe=setTimeout(()=>{i.style.opacity="0",i.style.visibility="hidden",Oe=null},3e3))},Le=()=>{if(y.value){try{y.value._monitorInterval&&clearInterval(y.value._monitorInterval),y.value._mutationObserver&&y.value._mutationObserver.disconnect(),y.value._resizeHandler&&y.value._iframeDoc&&y.value._iframeDoc.defaultView.removeEventListener("resize",y.value._resizeHandler),y.value._fullscreenHandler&&y.value._iframeDoc&&(y.value._iframeDoc.removeEventListener("fullscreenchange",y.value._fullscreenHandler),y.value._iframeDoc.removeEventListener("webkitfullscreenchange",y.value._fullscreenHandler),y.value._videoElement&&(y.value._videoElement.removeEventListener("webkitbeginfullscreen",y.value._fullscreenHandler),y.value._videoElement.removeEventListener("webkitendfullscreen",y.value._fullscreenHandler))),y.value._mouseHandler&&y.value._iframeDoc&&y.value._iframeDoc.removeEventListener("mousemove",y.value._mouseHandler),y.value.remove()}catch(t){console.log("Error removing overlay:",t)}y.value=null}$e.value=!1,Xe.value&&(clearTimeout(Xe.value),Xe.value=null)};vo(()=>{if(ie.value=!0,ko(),ft.value&&(Re.value="4:3"),$t(),window.addEventListener("resize",$t),window.addEventListener("resize",It),it.value&&lt(),window.toggleCompressor=Yt,window.toggleMirror=jt,eo(),window.connectToOBS=Nt,window.testOBSBlur=Go,window.refreshOBSFilters=Yo,window.getOBSFiltersInfo=jo,window.testOBSConnection=Zo,window.debugOBS=()=>{var t;console.log("=== OBS Debug Info ==="),console.log("OBS Settings:",de.value),console.log("OBS Connected:",Ae.value),console.log("OBS Filters Found:",Je.value),console.log("OBS WebSocket instance:",Z.value),Z.value&&(console.log("WebSocket state:",(t=Z.value.ws)==null?void 0:t.readyState),console.log("Is Connected:",Z.value.isConnected),console.log("Is Authenticated:",Z.value.isAuthenticated))},de.value.enabled&&Nt(),E.value&&(Ct.value=setInterval(()=>{const t=window.overlayNudityTimings?window.overlayNudityTimings.length:0;t>yt.value?(yt.value=t,V.value||(V.value=!0,window.electronAPI&&window.electronAPI.showToast("Оверлей автоматически включён - добавлены тайминги"))):yt.value=t},1e3)),E.value&&V.value){const t=()=>{if(k.value&&!y.value)try{const e=k.value,o=e.contentDocument||e.contentWindow.document;if(o){const s=o.querySelector("video");if(s){const i=Date.now()-(window.iframeLoadTime||0);i>=100?Qe(o,s):setTimeout(t,100-i)}}}catch(e){console.log("Error initializing overlay on mount:",e),$e.value=!1}};setTimeout(t,1e3)}}),tn(()=>{window.removeEventListener("resize",$t),window.removeEventListener("resize",It),window.removeEventListener("mousemove",Bt),document.removeEventListener("keydown",Ft),document.body.classList.remove("no-scroll"),me.value&&clearInterval(me.value),fe.value&&clearInterval(fe.value),Ct.value&&clearInterval(Ct.value),Le(),Do(),to(),delete window.toggleCompressor,delete window.toggleMirror,delete window.connectToOBS,delete window.testOBSBlur,delete window.refreshOBSFilters,delete window.getOBSFiltersInfo,delete window.testOBSConnection,delete window.debugOBS,delete window.obsSources,delete window.obsFiltersFound});const Zo=async()=>Z.value&&Ae.value?await Z.value.testConnection():{success:!1,error:"Not connected"};return(t,e)=>{var o,s,i,m,_,w,a,b,A,G,Q,ve,Y,R,W,ue,be,ne,j,re,we,Fe,Pe,Ke,at,Ot,_e,Rt,rt,ct,ut,De,dt,u,N,L,ge,Me,pe,se,qe,ye,Ge;return z.value?(x(),Lt(on,{key:0,message:z.value,code:Be.value},null,8,["message","code"])):(x(),I(He,{key:1},[n("div",Tn,[e[45]||(e[45]=n("span",null,"Плеер:",-1)),n("button",{class:"player-btn",onClick:xo},S(M.value?Qt(M.value.translate).toUpperCase():"Загрузка плееров..."),1),Ht.value?(x(),I("button",{key:0,class:"source-btn",onClick:So},"Источник")):oe("",!0)]),Ne.value?(x(),Lt(In,{key:0,players:J.value,"selected-player":M.value,onClose:Gt,onSelect:qo},null,8,["players","selected-player"])):oe("",!0),g.value?(x(),I("div",{key:1,class:"source-modal-backdrop",onClick:pt(At,["self"])},[n("div",$n,[n("div",{class:"source-modal-header"},[e[46]||(e[46]=n("h3",null,"Выбор источника KinoBD",-1)),n("button",{class:"source-close-btn",onClick:At},"×")]),v.value?(x(),I("div",An,"Загрузка источников...")):O.value?(x(),I("div",Mn,S(O.value),1)):B.value.length===0?(x(),I("div",Bn,"Источники не найдены")):(x(),I("ul",Fn,[(x(!0),I(He,null,nt(B.value,d=>(x(),I("li",{key:d.id},[n("button",{class:"source-candidate-btn",onClick:vt=>Co(d)},[n("span",Nn,S(d.title||"ID ".concat(d.id)),1),n("span",On,"inid: "+S(d.id)+" · kp: "+S(d.kp_id||"-"),1)],8,Pn)]))),128))]))])])):oe("",!0),n("div",{ref_key:"containerRef",ref:Ce,class:q(["player-container",{"theater-mode":K.value}]),style:so(K.value?{}:bo.value)},[n("div",{class:"iframe-wrapper",style:so(K.value?{}:wo.value)},[ee(n("iframe",{ref_key:"playerIframe",ref:k,src:(o=M.value)==null?void 0:o.iframe,frameborder:"0",allowfullscreen:"",webkitallowfullscreen:"",class:q(["responsive-iframe",{"theater-mode-unlock":F.value,"theater-mode-lock":K.value,dimmed:kt.value}]),onLoad:No},null,42,Rn),[[te,!ie.value&&((s=M.value)==null?void 0:s.iframe)]]),ie.value?(x(),Lt(dn,{key:0,text:"Загружается плеер: ".concat(M.value?Qt(M.value.translate):"Загружается список плееров","\nЕсли плеер не грузится, то смените плеер выше или включите VPN"),style:{"white-space":"pre-line"}},null,8,["text"])):oe("",!0)],4),K.value?(x(),I("button",{key:0,class:q(["close-theater-btn",{visible:F.value}]),onClick:wt}," ✖ ",2)):oe("",!0)],6),K.value?oe("",!0):(x(),I("div",Ln,[n("div",_n,[!ft.value&&$.value?(x(),I("div",{key:0,ref_key:"tooltipContainer",ref:fo,class:"tooltip-container list-buttons-container","data-tooltip-container":"favorite"},[Pt.value?(x(),I("button",{key:0,class:q(["favorite-btn",{active:(m=(i=H.movieInfo)==null?void 0:i.lists)==null?void 0:m.isFavorite}]),onMouseenter:e[0]||(e[0]=d=>le("favorite")),onMouseleave:Et,onClick:e[1]||(e[1]=d=>Se(he(X).FAVORITE))},[n("span",Dn,S((w=(_=H.movieInfo)==null?void 0:_.lists)!=null&&w.isFavorite?"favorite":"favorite_border"),1),n("span",{class:q(["material-icons dropdown-arrow",{highlighted:yo.value}])},"expand_more",2)],34)):oe("",!0),ee(n("div",{ref_key:"tooltip",ref:go,class:"custom-tooltip advanced-tooltip list-buttons-dropdown","data-tooltip":"favorite",onMouseenter:Tt,onMouseleave:ht},[n("div",qn,[n("button",{class:q(["favorite-btn",{active:(b=(a=H.movieInfo)==null?void 0:a.lists)==null?void 0:b.isFavorite}]),onClick:e[2]||(e[2]=d=>Se(he(X).FAVORITE))},[n("span",Hn,S((G=(A=H.movieInfo)==null?void 0:A.lists)!=null&&G.isFavorite?"favorite":"favorite_border"),1),e[47]||(e[47]=n("span",{class:"button-label"},"В избранное",-1))],2)]),n("div",Vn,[n("button",{class:q(["watching-btn",{active:(ve=(Q=H.movieInfo)==null?void 0:Q.lists)==null?void 0:ve.isWatching}]),onClick:e[3]||(e[3]=d=>Se(he(X).WATCHING))},[n("span",Wn,S((R=(Y=H.movieInfo)==null?void 0:Y.lists)!=null&&R.isWatching?"visibility":"visibility_off"),1),e[48]||(e[48]=n("span",{class:"button-label"},"Смотрю",-1))],2)]),n("div",zn,[n("button",{class:q(["later-btn",{active:(ue=(W=H.movieInfo)==null?void 0:W.lists)==null?void 0:ue.isLater}]),onClick:e[4]||(e[4]=d=>Se(he(X).LATER))},[...e[49]||(e[49]=[n("span",{class:"material-icons"},"watch_later",-1),n("span",{class:"button-label"},"Смотреть позже",-1)])],2)]),n("div",Un,[n("button",{class:q(["completed-btn",{active:(ne=(be=H.movieInfo)==null?void 0:be.lists)==null?void 0:ne.isCompleted}]),onClick:e[5]||(e[5]=d=>Se(he(X).COMPLETED))},[n("span",Kn,S((re=(j=H.movieInfo)==null?void 0:j.lists)!=null&&re.isCompleted?"check_circle":"check_circle_outline"),1),e[50]||(e[50]=n("span",{class:"button-label"},"Просмотрено",-1))],2)]),n("div",Gn,[n("button",{class:q(["abandoned-btn",{active:(Fe=(we=H.movieInfo)==null?void 0:we.lists)==null?void 0:Fe.isAbandoned}]),onClick:e[6]||(e[6]=d=>Se(he(X).ABANDONED))},[n("span",Yn,S(((Ke=(Pe=H.movieInfo)==null?void 0:Pe.lists)!=null&&Ke.isAbandoned,"not_interested")),1),e[51]||(e[51]=n("span",{class:"button-label"},"Брошено",-1))],2)]),n("div",{class:"tooltip-hint"},[e[53]||(e[53]=n("span",{class:"material-icons"},"settings",-1)),n("span",null,[e[52]||(e[52]=Ye("Стиль отображения можно изменить в ",-1)),n("a",{class:"settings-link",onClick:zo},"настройках")])])],544),[[te,T.value==="favorite"&&Pt.value]])],512)):oe("",!0),ft.value?oe("",!0):(x(),I(He,{key:1},[n("div",jn,[n("button",{class:q(["dimming-btn",{active:kt.value}]),onMouseenter:e[7]||(e[7]=d=>le("dimming")),onMouseleave:e[8]||(e[8]=d=>T.value=null),onClick:Mo},[n("span",Xn,S(kt.value?"light_mode":"dark_mode"),1)],34),ee(n("div",{class:"custom-tooltip","data-tooltip":"dimming"},S(kt.value?"Отключить затемнение":"Включить затемнение"),513),[[te,T.value==="dimming"]])]),n("div",Jn,[n("button",{class:q(["blur-btn",{"electron-only":!E.value}]),onMouseenter:e[9]||(e[9]=d=>le("blur")),onMouseleave:e[10]||(e[10]=d=>T.value=null),onClick:Ao},[...e[54]||(e[54]=[n("span",{class:"material-icons"},"blur_on",-1)])],34),ee(n("div",{class:"custom-tooltip","data-tooltip":"blur"},S(E.value?"Блюр":"Блюр, функция доступна в приложении"),513),[[te,T.value==="blur"]])]),n("div",Zn,[n("button",{class:q(["material-symbols-outlined",{active:Ue.value,"electron-only":!E.value}]),onMouseenter:e[11]||(e[11]=d=>le("compressor")),onMouseleave:e[12]||(e[12]=d=>T.value=null),onClick:Yt},[...e[55]||(e[55]=[n("span",{class:"material-icons"},"graphic_eq",-1)])],34),ee(n("div",{class:"custom-tooltip","data-tooltip":"compressor"},S(E.value?"Компрессор":"Компрессор, функция доступна в приложении"),513),[[te,T.value==="compressor"]])]),n("div",Qn,[n("button",{class:q(["mirror-btn",{active:Ze.value,"electron-only":!E.value}]),onMouseenter:e[13]||(e[13]=d=>le("mirror")),onMouseleave:e[14]||(e[14]=d=>T.value=null),onClick:jt},[...e[56]||(e[56]=[n("span",{class:"material-icons"},"flip",-1)])],34),ee(n("div",{class:"custom-tooltip","data-tooltip":"mirror"},S(E.value?"Зеркало":"Зеркало, функция доступна в приложении"),513),[[te,T.value==="mirror"]])]),n("div",es,[n("button",{class:"theater-mode-btn",onMouseenter:e[15]||(e[15]=d=>le("theater")),onMouseleave:e[16]||(e[16]=d=>T.value=null),onClick:wt},[n("span",ts,S(K.value?"fullscreen_exit":"aspect_ratio"),1)],32),ee(n("div",os,[Ye(S(K.value?"Выйти из театрального режима":"Театральный режим")+" ",1),e[57]||(e[57]=n("span",{class:"shortcut-hint"},"Alt+T",-1))],512),[[te,T.value==="theater"]])]),n("div",ns,[n("button",{class:q(["pip-btn",{"electron-only":!E.value}]),onMouseenter:e[17]||(e[17]=d=>le("pip")),onMouseleave:e[18]||(e[18]=d=>T.value=null),onClick:Uo},[...e[58]||(e[58]=[n("span",{class:"material-icons"},"picture_in_picture_alt",-1)])],34),ee(n("div",{class:"custom-tooltip","data-tooltip":"pip"},S(E.value?"Картинка в картинке":"Картинка в картинке, функция доступна в приложении"),513),[[te,T.value==="pip"]])]),n("div",ss,[n("button",{class:"aspect-ratio-dropdown-btn",onMouseenter:e[19]||(e[19]=d=>le("aspect_ratio")),onMouseleave:Et,onClick:Ho},[n("span",is,S(Re.value),1)],32),ee(n("div",{class:"custom-tooltip advanced-tooltip aspect-ratio-dropdown","data-tooltip":"aspect_ratio",onMouseenter:Tt,onMouseleave:ht},[(x(),I(He,null,nt(xt,d=>n("div",{key:d,class:q(["aspect-ratio-option",{active:Re.value===d}]),onClick:vt=>Jt(d)},S(d),11,ls)),64))],544),[[te,T.value==="aspect_ratio"]])]),n("div",{class:"tooltip-container","data-tooltip-container":"centering",onMouseenter:e[21]||(e[21]=d=>le("centering")),onMouseleave:Et},[n("button",{class:"center-btn",onClick:lt},[...e[59]||(e[59]=[n("span",{class:"material-icons"},"center_focus_strong",-1)])]),ee(n("div",{class:"custom-tooltip advanced-tooltip","data-tooltip":"centering",onMouseenter:Tt,onMouseleave:ht},[e[60]||(e[60]=Ye(" Отцентрировать плеер ",-1)),Dt(pn,{modelValue:it.value,"onUpdate:modelValue":e[20]||(e[20]=d=>it.value=d),title:"Автоцентрирование плеера"},null,8,["modelValue"]),e[61]||(e[61]=n("span",{class:"tooltip-title"},"Автоцентрирование плеера",-1))],544),[[te,T.value==="centering"]])],32),!E.value&&$.value?(x(),I("div",as,[n("button",{class:"app-link-btn",onMouseenter:e[22]||(e[22]=d=>le("app_link")),onMouseleave:e[23]||(e[23]=d=>T.value=null),onClick:Oo},[...e[62]||(e[62]=[n("span",{class:"material-icons"},"open_in_new",-1)])],32),ee(n("div",rs," Открыть в приложении ",512),[[te,T.value==="app_link"]])])):oe("",!0),(at=M.value)!=null&&at.iframe?(x(),I("div",cs,[n("button",{class:"mpv-btn",onMouseenter:e[24]||(e[24]=d=>le("mpv")),onMouseleave:e[25]||(e[25]=d=>T.value=null),onClick:Lo},[...e[63]||(e[63]=[n("span",{class:"material-icons"},"terminal",-1)])],32),ee(n("div",us," Скопировать для mpv ",512),[[te,T.value==="mpv"]])])):oe("",!0),E.value?(x(),I("div",ds,[n("button",{class:"copy-link-btn",onMouseenter:e[26]||(e[26]=d=>le("copy_link")),onMouseleave:e[27]||(e[27]=d=>T.value=null),onClick:_o},[...e[64]||(e[64]=[n("span",{class:"material-icons"},"content_copy",-1)])],32),ee(n("div",vs," Скопировать ссылку ",512),[[te,T.value==="copy_link"]])])):oe("",!0),E.value?(x(),I("div",ps,[n("button",{class:q(["overlay-btn",{active:V.value}]),onMouseenter:e[28]||(e[28]=d=>le("overlay")),onMouseleave:e[29]||(e[29]=d=>T.value=null),onClick:Ko},[n("span",ms,S(V.value?"layers":"layers_clear"),1)],34),ee(n("div",{class:"custom-tooltip","data-tooltip":"overlay"},S(V.value?"Скрыть оверлей видео":"Показать оверлей видео"),513),[[te,T.value==="overlay"]])])):oe("",!0)],64))]),!ft.value&&!Pt.value&&$.value?(x(),I("div",fs,[n("div",gs,[n("button",{class:q(["favorite-btn",{active:(_e=(Ot=H.movieInfo)==null?void 0:Ot.lists)==null?void 0:_e.isFavorite}]),onMouseenter:e[30]||(e[30]=d=>le("favorite")),onMouseleave:e[31]||(e[31]=d=>T.value=null),onClick:e[32]||(e[32]=d=>Se(he(X).FAVORITE))},[n("span",ys,S((rt=(Rt=H.movieInfo)==null?void 0:Rt.lists)!=null&&rt.isFavorite?"favorite":"favorite_border"),1)],34),ee(n("div",hs,S("В избранное"),512),[[te,T.value==="favorite"]])]),n("div",bs,[n("button",{class:q(["watching-btn",{active:(ut=(ct=H.movieInfo)==null?void 0:ct.lists)==null?void 0:ut.isWatching}]),onMouseenter:e[33]||(e[33]=d=>le("watching")),onMouseleave:e[34]||(e[34]=d=>T.value=null),onClick:e[35]||(e[35]=d=>Se(he(X).WATCHING))},[n("span",ws,S((dt=(De=H.movieInfo)==null?void 0:De.lists)!=null&&dt.isWatching?"visibility":"visibility_off"),1)],34),ee(n("div",ks,S("Смотрю"),512),[[te,T.value==="watching"]])]),n("div",xs,[n("button",{class:q(["later-btn",{active:(N=(u=H.movieInfo)==null?void 0:u.lists)==null?void 0:N.isLater}]),onMouseenter:e[36]||(e[36]=d=>le("later")),onMouseleave:e[37]||(e[37]=d=>T.value=null),onClick:e[38]||(e[38]=d=>Se(he(X).LATER))},[...e[65]||(e[65]=[n("span",{class:"material-icons"},"watch_later",-1)])],34),ee(n("div",Ss,S("Смотреть позже"),512),[[te,T.value==="later"]])]),n("div",Cs,[n("button",{class:q(["completed-btn",{active:(ge=(L=H.movieInfo)==null?void 0:L.lists)==null?void 0:ge.isCompleted}]),onMouseenter:e[39]||(e[39]=d=>le("completed")),onMouseleave:e[40]||(e[40]=d=>T.value=null),onClick:e[41]||(e[41]=d=>Se(he(X).COMPLETED))},[n("span",Is,S((pe=(Me=H.movieInfo)==null?void 0:Me.lists)!=null&&pe.isCompleted?"check_circle":"check_circle_outline"),1)],34),ee(n("div",Es,S("Просмотрено"),512),[[te,T.value==="completed"]])]),n("div",Ts,[n("button",{class:q(["abandoned-btn",{active:(qe=(se=H.movieInfo)==null?void 0:se.lists)==null?void 0:qe.isAbandoned}]),onMouseenter:e[42]||(e[42]=d=>le("abandoned")),onMouseleave:e[43]||(e[43]=d=>T.value=null),onClick:e[44]||(e[44]=d=>Se(he(X).ABANDONED))},[n("span",$s,S(((Ge=(ye=H.movieInfo)==null?void 0:ye.lists)!=null&&Ge.isAbandoned,"not_interested")),1)],34),ee(n("div",As,S("Брошено"),512),[[te,T.value==="abandoned"]])])])):oe("",!0)])),Dt(po,{ref_key:"notificationRef",ref:Ie},null,512)],64))}}},Gs=qt(Ms,[["__scopeId","data-v-3a9fab9d"]]),Bs={class:"rating-container"},Fs={class:"rating-display"},Ps={class:"rating-numbers"},Ns=["onClick","onMouseenter"],Os={key:0,class:"tooltip-footer"},Rs={class:"rating-numbers mobile-rating-numbers"},Ls=["onClick"],_s={key:0,class:"mobile-modal-footer"},Ds={__name:"MovieRating",props:{kpId:{type:String,required:!0},showDash:{type:Boolean,default:!1}},setup(H){const l=co(),p=uo(),r=H,h=f(null),C=f(null),D=f(null),$=f(null),c=f(0),U=f(!1),J=f(!1);let M=null;const ie=v=>v?v.toString().replace(/\B(?=(\d{3})+(?!\d))/g," "):"0",K=()=>{M=setTimeout(()=>{U.value=!1,l.isMobile||(J.value=!1)},100)},F=()=>{M&&(clearTimeout(M),M=null),U.value=!0},k=()=>{l.isMobile&&(J.value=!J.value)},Ce=()=>{p.push("/login")},Ne=async()=>{try{const v=await un(r.kpId);C.value=v.user_rating,D.value=v.average_rating,$.value=ie(v.vote_count)}catch(v){console.error("Error loading rating:",v)}},g=async v=>{var O;try{v===C.value?(await ro(r.kpId,null),C.value=null,h.value.showNotification("Оценка удалена")):(await ro(r.kpId,v),C.value=v,h.value.showNotification("Оценка сохранена")),l.isMobile&&(J.value=!1),Ne()}catch(z){console.error("Error setting rating:",z),((O=z.response)==null?void 0:O.status)===401?h.value.showNotification('Для оценки необходимо <a class="auth-link">авторизоваться</a>',5e3,{onClick:Ce}):h.value.showNotification("Ошибка при сохранении оценки"),l.isMobile&&(J.value=!1)}},B=()=>{J.value=!1};return vo(()=>{Ne()}),(v,O)=>(x(),I("div",Bs,[n("div",Fs,[n("a",{href:"#",class:q(["rating-link",{"has-rating":C.value}]),onMouseenter:O[0]||(O[0]=z=>U.value=!0),onMouseleave:K,onClick:pt(k,["prevent"])},[O[3]||(O[3]=n("img",{src:mn,alt:"ReYohoho",class:"rating-logo"},null,-1)),n("span",{class:q(["average-rating",he(cn)(D.value)])},S(D.value?D.value.toFixed(1).replace(/\.0$/,""):"—"),3)],34),ee(n("div",{class:"rating-tooltip",onMouseenter:F,onMouseleave:K},[n("div",Ps,[(x(),I(He,null,nt(10,z=>n("button",{key:z,class:q(["number-btn",{active:z===C.value,hover:z===c.value,"average-highlight":D.value&&z<=Math.round(D.value)}]),onClick:Be=>g(z),onMouseenter:Be=>c.value=z,onMouseleave:O[1]||(O[1]=Be=>c.value=0)},S(z),43,Ns)),64))]),$.value?(x(),I("div",Os,"Оценок: "+S($.value),1)):oe("",!0)],544),[[te,(U.value||J.value)&&!he(l).isMobile]])]),Dt(po,{ref_key:"notificationRef",ref:h},null,512),he(l).isMobile&&J.value?(x(),I("div",{key:0,class:"mobile-modal-overlay",onClick:B},[n("div",{class:"mobile-modal",onClick:O[2]||(O[2]=pt(()=>{},["stop"]))},[n("div",{class:"mobile-modal-header"},[O[4]||(O[4]=n("h3",null,"Оценить фильм",-1)),n("button",{class:"close-button",onClick:B},"×")]),n("div",Rs,[(x(),I(He,null,nt(10,z=>n("button",{key:z,class:q(["number-btn",{active:z===C.value,"average-highlight":D.value&&z<=Math.round(D.value)}]),onClick:Be=>g(z)},S(z),11,Ls)),64))]),$.value?(x(),I("div",_s,"Оценок: "+S($.value),1)):oe("",!0)])])):oe("",!0)]))}},Ys=qt(Ds,[["__scopeId","data-v-2df64bd5"]]);export{Ys as M,Gs as P,Us as _,Ks as a};
